<!DOCTYPE html>
<html lang="ro">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Test Orders System | AutoParts</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/@supabase/supabase-js@2"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
</head>
<body class="bg-gray-50 p-8">
    <div class="max-w-4xl mx-auto">
        <h1 class="text-3xl font-bold text-gray-900 mb-8">Test Orders System</h1>
        
        <!-- Auth Status -->
        <div class="bg-white rounded-lg shadow-sm p-6 mb-6">
            <h2 class="text-xl font-semibold mb-4">Authentication Status</h2>
            <div id="auth-status" class="text-gray-600">Checking authentication...</div>
            <div id="auth-actions" class="mt-4 space-x-4">
                <button id="login-btn" class="bg-blue-600 text-white px-4 py-2 rounded hover:bg-blue-700">Login</button>
                <button id="logout-btn" class="bg-red-600 text-white px-4 py-2 rounded hover:bg-red-700">Logout</button>
            </div>
        </div>

        <!-- Cart Operations -->
        <div class="bg-white rounded-lg shadow-sm p-6 mb-6">
            <h2 class="text-xl font-semibold mb-4">Cart Operations</h2>
            
            <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-4">
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">Add Product to Cart (Test)</label>
                    <button id="add-test-product" class="w-full bg-green-600 text-white px-4 py-2 rounded hover:bg-green-700">
                        Add Test Product
                    </button>
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">Apply Promo Code</label>
                    <div class="flex space-x-2">
                        <select id="promo-select" class="flex-1 border border-gray-300 rounded px-3 py-2">
                            <option value="WELCOME10">WELCOME10 (10% off)</option>
                            <option value="SAVE20EUR">SAVE20EUR (20 EUR off)</option>
                            <option value="FREESHIP">FREESHIP (Free shipping)</option>
                        </select>
                        <button id="apply-promo" class="bg-purple-600 text-white px-4 py-2 rounded hover:bg-purple-700">
                            Apply
                        </button>
                    </div>
                </div>
            </div>
            
            <div id="cart-display" class="bg-gray-50 p-4 rounded">
                <h3 class="font-medium mb-2">Cart Contents:</h3>
                <pre id="cart-contents" class="text-sm text-gray-700">Loading...</pre>
            </div>
        </div>

        <!-- Order Operations -->
        <div class="bg-white rounded-lg shadow-sm p-6 mb-6">
            <h2 class="text-xl font-semibold mb-4">Order Operations</h2>
            
            <div class="mb-4">
                <button id="create-test-order" class="bg-orange-600 text-white px-4 py-2 rounded hover:bg-orange-700 mr-4">
                    Create Test Order
                </button>
                <button id="load-user-orders" class="bg-indigo-600 text-white px-4 py-2 rounded hover:bg-indigo-700">
                    Load My Orders
                </button>
            </div>
            
            <div id="order-display" class="bg-gray-50 p-4 rounded">
                <h3 class="font-medium mb-2">Orders:</h3>
                <div id="order-contents">No orders loaded</div>
            </div>
        </div>

        <!-- Database Check -->
        <div class="bg-white rounded-lg shadow-sm p-6 mb-6">
            <h2 class="text-xl font-semibold mb-4">Database Tables Check</h2>
            <button id="check-tables" class="bg-gray-600 text-white px-4 py-2 rounded hover:bg-gray-700 mb-4">
                Check Tables
            </button>
            <div id="tables-status" class="bg-gray-50 p-4 rounded text-sm"></div>
        </div>

        <!-- Logs -->
        <div class="bg-white rounded-lg shadow-sm p-6">
            <h2 class="text-xl font-semibold mb-4">System Logs</h2>
            <div id="logs" class="bg-gray-900 text-green-400 p-4 rounded font-mono text-sm h-64 overflow-y-auto"></div>
            <button id="clear-logs" class="mt-2 bg-gray-600 text-white px-4 py-2 rounded hover:bg-gray-700">
                Clear Logs
            </button>
        </div>
    </div>

    <!-- Scripts -->
    <script src="js/app-universal.js"></script>
    <script type="module">
        import { CONFIG, UTILS } from './js/config.js';
        
        let logs = [];
        
        function log(message) {
            const timestamp = new Date().toLocaleTimeString();
            logs.push(`[${timestamp}] ${message}`);
            document.getElementById('logs').innerHTML = logs.join('\n');
            document.getElementById('logs').scrollTop = document.getElementById('logs').scrollHeight;
            console.log(message);
        }
        
        function updateCartDisplay() {
            if (window.cartManager) {
                const cart = window.cartManager.getCart();
                document.getElementById('cart-contents').textContent = JSON.stringify(cart, null, 2);
            } else {
                document.getElementById('cart-contents').textContent = 'Cart Manager not available';
            }
        }
        
        function updateAuthStatus() {
            const statusEl = document.getElementById('auth-status');
            const loginBtn = document.getElementById('login-btn');
            const logoutBtn = document.getElementById('logout-btn');
            
            if (window.authManager && window.authManager.isAuthenticated()) {
                const user = window.authManager.getUser();
                statusEl.innerHTML = `
                    <div class="text-green-600">
                        <i class="fas fa-check-circle mr-2"></i>
                        Authenticated as: ${user.email}
                    </div>
                `;
                loginBtn.style.display = 'none';
                logoutBtn.style.display = 'inline-block';
            } else {
                statusEl.innerHTML = `
                    <div class="text-red-600">
                        <i class="fas fa-times-circle mr-2"></i>
                        Not authenticated
                    </div>
                `;
                loginBtn.style.display = 'inline-block';
                logoutBtn.style.display = 'none';
            }
        }
        
        // Wait for dependencies
        function waitForDependencies() {
            return new Promise((resolve) => {
                const check = () => {
                    if (window.CONFIG && window.cartManager && window.orderManager && window.authManager) {
                        resolve();
                    } else {
                        setTimeout(check, 100);
                    }
                };
                check();
            });
        }
        
        async function init() {
            log('Initializing test system...');
            
            try {
                await waitForDependencies();
                log('✅ All dependencies loaded');
                
                updateAuthStatus();
                updateCartDisplay();
                
                // Event listeners
                document.getElementById('login-btn').addEventListener('click', () => {
                    window.location.href = '/login.html';
                });
                
                document.getElementById('logout-btn').addEventListener('click', async () => {
                    try {
                        await window.authManager.signOut();
                        log('✅ Logged out successfully');
                        updateAuthStatus();
                    } catch (error) {
                        log('❌ Logout error: ' + error.message);
                    }
                });
                
                document.getElementById('add-test-product').addEventListener('click', async () => {
                    try {
                        // Create a mock product entry in the cart system
                        const mockProduct = {
                            id: 'test-product-1',
                            name: 'Test Auto Part',
                            sku: 'TEST-001',
                            price: 99.99,
                            sale_price: null,
                            stock_quantity: 10,
                            is_active: true,
                            images: ['/images/placeholder.jpg'],
                            categories: { name: 'Test Category' },
                            brands: { name: 'Test Brand' }
                        };
                        
                        // Override the getProductDetails method temporarily for testing
                        const originalMethod = window.cartManager.getProductDetails;
                        window.cartManager.getProductDetails = async function(productId) {
                            if (productId === 'test-product-1') {
                                return mockProduct;
                            }
                            return originalMethod.call(this, productId);
                        };
                        
                        // Add to cart
                        const result = await window.cartManager.addItem('test-product-1', 1);
                        
                        // Restore original method
                        window.cartManager.getProductDetails = originalMethod;
                        
                        if (result.success) {
                            log('✅ Test product added to cart');
                            updateCartDisplay();
                        } else {
                            log('❌ Failed to add product: ' + result.error);
                        }
                    } catch (error) {
                        log('❌ Add product error: ' + error.message);
                    }
                });
                
                document.getElementById('apply-promo').addEventListener('click', async () => {
                    try {
                        const promoCode = document.getElementById('promo-select').value;
                        const result = await window.cartManager.applyPromocode(promoCode);
                        
                        if (result.success) {
                            log(`✅ Promo code ${promoCode} applied successfully`);
                            updateCartDisplay();
                        } else {
                            log('❌ Failed to apply promo: ' + result.error);
                        }
                    } catch (error) {
                        log('❌ Promo application error: ' + error.message);
                    }
                });
                
                document.getElementById('create-test-order').addEventListener('click', async () => {
                    try {
                        if (!window.authManager.isAuthenticated()) {
                            log('❌ Must be authenticated to create orders');
                            return;
                        }
                        
                        if (window.cartManager.isEmpty()) {
                            log('❌ Cart is empty - add products first');
                            return;
                        }
                        
                        const orderData = {
                            firstName: 'Test',
                            lastName: 'User',
                            email: window.authManager.getUser().email,
                            phone: '+40123456789',
                            billingAddress: {
                                street: 'Test Street 123',
                                city: 'Bucharest',
                                state: 'Bucharest',
                                postalCode: '010101',
                                country: 'România'
                            },
                            sameAsShipping: true,
                            paymentMethod: 'cash',
                            shippingMethod: 'standard'
                        };
                        
                        const result = await window.orderManager.createOrder(orderData);
                        
                        if (result.success) {
                            log(`✅ Order created successfully: ${result.order.order_number}`);
                            updateCartDisplay();
                        } else {
                            log('❌ Failed to create order: ' + result.error);
                        }
                    } catch (error) {
                        log('❌ Order creation error: ' + error.message);
                    }
                });
                
                document.getElementById('load-user-orders').addEventListener('click', async () => {
                    try {
                        if (!window.authManager.isAuthenticated()) {
                            log('❌ Must be authenticated to load orders');
                            return;
                        }
                        
                        const userId = window.authManager.getUserId();
                        const orders = await window.orderManager.getUserOrders(userId);
                        
                        document.getElementById('order-contents').innerHTML = orders.length ? 
                            orders.map(order => `
                                <div class="border border-gray-200 rounded p-3 mb-2">
                                    <strong>Order #${order.order_number}</strong><br>
                                    Status: ${order.status}<br>
                                    Total: ${UTILS.formatPrice(order.total)}<br>
                                    Date: ${new Date(order.created_at).toLocaleString()}
                                </div>
                            `).join('') : 
                            'No orders found';
                            
                        log(`✅ Loaded ${orders.length} orders`);
                    } catch (error) {
                        log('❌ Load orders error: ' + error.message);
                    }
                });
                
                document.getElementById('check-tables').addEventListener('click', async () => {
                    try {
                        const tables = ['orders', 'order_items', 'payments', 'promocodes', 'user_addresses'];
                        const statusDiv = document.getElementById('tables-status');
                        statusDiv.innerHTML = '';
                        
                        for (const table of tables) {
                            try {
                                const { data, error } = await CONFIG.supabase
                                    .from(table)
                                    .select('*')
                                    .limit(1);
                                    
                                const status = error ? `❌ ${error.message}` : '✅ OK';
                                statusDiv.innerHTML += `<div>${table}: ${status}</div>`;
                            } catch (err) {
                                statusDiv.innerHTML += `<div>${table}: ❌ ${err.message}</div>`;
                            }
                        }
                        
                        log('✅ Database tables checked');
                    } catch (error) {
                        log('❌ Table check error: ' + error.message);
                    }
                });
                
                document.getElementById('clear-logs').addEventListener('click', () => {
                    logs = [];
                    document.getElementById('logs').innerHTML = '';
                });
                
                log('✅ Test system initialized successfully');
                
            } catch (error) {
                log('❌ Initialization error: ' + error.message);
            }
        }
        
        // Wait for dependencies to load from app-universal.js
        function waitForDependencies() {
            return new Promise((resolve) => {
                const checkDeps = () => {
                    if (window.CONFIG && window.cartManager && window.orderManager && window.authManager) {
                        resolve();
                    } else {
                        setTimeout(checkDeps, 100);
                    }
                };
                checkDeps();
            });
        }
        
        // Start initialization when dependencies are ready
        waitForDependencies().then(() => {
            log('All dependencies loaded, starting initialization...');
            init();
        }).catch(error => {
            log('❌ Dependencies loading error: ' + error.message);
        });
            
        // Auth state listener
        window.addEventListener('authStateChange', () => {
            updateAuthStatus();
        });
    </script>
</body>
</html>