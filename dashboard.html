<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dashboard - Van Hool Parts</title>
    <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <link href="css/custom-colors.css" rel="stylesheet">
    
    <!-- Supabase -->
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
</head>
<body class="bg-gray-50 min-h-screen">
    <!-- Navigation -->
    <nav class="bg-white shadow-lg">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
            <div class="flex justify-between h-16">
                <div class="flex items-center">
                    <a href="index.html" class="flex items-center space-x-2">
                        <img src="LOGO1 1.svg" alt="Van Hool Parts" class="h-8 lg:h-10 w-auto">
                    </a>
                </div>
                
                <div class="flex items-center space-x-6">
                    <a href="catalog.html" class="text-gray-600 hover:text-red-600">Catalog</a>
                    
                    <!-- Language Switcher -->
                    <div class="relative group hidden sm:block">
                        <button class="flex items-center space-x-1 text-gray-700 hover:text-red-600 py-2 px-2 lg:px-3 rounded-md transition-colors">
                            <span id="current-lang" class="text-sm font-medium">EN</span>
                            <i class="fas fa-chevron-down text-xs"></i>
                        </button>
                        <div class="absolute top-full right-0 bg-white shadow-lg border rounded-lg hidden group-hover:block z-50 min-w-max">
                            <button onclick="setLanguage('en')" class="block px-4 py-2 text-sm text-gray-700 hover:bg-gray-50 w-full text-left">üá¨üáß English</button>
                            <button onclick="setLanguage('ro')" class="block px-4 py-2 text-sm text-gray-700 hover:bg-gray-50 w-full text-left">üá∑üá¥ Rom√¢nƒÉ</button>
                            <button onclick="setLanguage('ru')" class="block px-4 py-2 text-sm text-gray-700 hover:bg-gray-50 w-full text-left">üá∑üá∫ –†—É—Å—Å–∫–∏–π</button>
                        </div>
                    </div>
                    
                    <!-- User menu -->
                    <div class="relative">
                        <button id="user-menu-button" class="flex items-center space-x-2 text-gray-700 hover:text-red-600">
                            <i class="fas fa-user-circle text-xl"></i>
                            <span id="user-name">Loading...</span>
                            <i class="fas fa-chevron-down text-sm"></i>
                        </button>
                        <div id="user-dropdown" class="hidden absolute right-0 mt-2 w-48 bg-white rounded-md shadow-lg py-1 z-50">
                            <a href="dashboard.html" class="block px-4 py-2 text-sm text-red-600 bg-red-50">Dashboard</a>
                            <a href="#" id="logout-btn" class="block px-4 py-2 text-sm text-gray-700 hover:bg-gray-100">Logout</a>
                        </div>
                    </div>
                    
                    <!-- Cart -->
                    <div class="relative">
                        <a href="cart.html" class="relative text-gray-600 hover:text-red-600">
                            <i class="fas fa-shopping-cart text-xl"></i>
                            <span id="cart-count" class="hidden absolute -top-2 -right-2 bg-red-500 text-white text-xs rounded-full h-5 w-5 flex items-center justify-center">0</span>
                        </a>
                    </div>
                </div>
            </div>
        </div>
    </nav>

    <!-- Main Content -->
    <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8">
        <!-- Welcome Section -->
        <div class="bg-white rounded-lg shadow-sm p-6 mb-8">
            <div class="flex items-center justify-between">
                <div>
                    <h1 class="text-2xl font-bold text-gray-900 mb-2">Welcome back!</h1>
                    <p class="text-gray-600" id="welcome-message">Loading your dashboard...</p>
                </div>
                <div class="text-red-600">
                    <i class="fas fa-user-circle text-4xl"></i>
                </div>
            </div>
        </div>

        <!-- Quick Actions -->
        <div class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-8">
            <a href="catalog.html" class="bg-white rounded-lg shadow-sm p-6 hover:shadow-md transition-shadow">
                <div class="flex items-center">
                    <div class="flex-shrink-0">
                        <i class="fas fa-search text-2xl text-red-600"></i>
                    </div>
                    <div class="ml-4">
                        <h3 class="text-lg font-semibold text-gray-900">Browse Parts</h3>
                        <p class="text-gray-600">Find Van Hool parts</p>
                    </div>
                </div>
            </a>

            <div class="bg-white rounded-lg shadow-sm p-6">
                <div class="flex items-center">
                    <div class="flex-shrink-0">
                        <i class="fas fa-shopping-bag text-2xl text-green-600"></i>
                    </div>
                    <div class="ml-4">
                        <h3 class="text-lg font-semibold text-gray-900">My Orders</h3>
                        <p class="text-gray-600" id="orders-count">0 orders</p>
                    </div>
                </div>
            </div>

            <div class="bg-white rounded-lg shadow-sm p-6">
                <div class="flex items-center">
                    <div class="flex-shrink-0">
                        <i class="fas fa-heart text-2xl text-red-600"></i>
                    </div>
                    <div class="ml-4">
                        <h3 class="text-lg font-semibold text-gray-900">Wishlist</h3>
                        <p class="text-gray-600" id="wishlist-count">0 items</p>
                    </div>
                </div>
            </div>
        </div>

        <!-- Account Information -->
        <div class="grid grid-cols-1 lg:grid-cols-2 gap-8">
            <!-- Profile Info -->
            <div class="bg-white rounded-lg shadow-sm">
                <div class="px-6 py-4 border-b border-gray-200">
                    <h2 class="text-lg font-semibold text-gray-900">Account Information</h2>
                </div>
                <div class="p-6">
                    <div class="space-y-4">
                        <div>
                            <label class="block text-sm font-medium text-gray-700">Email</label>
                            <p class="mt-1 text-sm text-gray-900" id="user-email">Loading...</p>
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700">Name</label>
                            <p class="mt-1 text-sm text-gray-900" id="user-full-name">Not set</p>
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700">Phone</label>
                            <p class="mt-1 text-sm text-gray-900" id="user-phone">Not set</p>
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700">Member Since</label>
                            <p class="mt-1 text-sm text-gray-900" id="member-since">Loading...</p>
                        </div>
                        <div>
                            <button class="text-sm text-red-600 hover:text-red-800">Edit Profile</button>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Recent Activity -->
            <div class="bg-white rounded-lg shadow-sm">
                <div class="px-6 py-4 border-b border-gray-200">
                    <h2 class="text-lg font-semibold text-gray-900">Recent Activity</h2>
                </div>
                <div class="p-6">
                    <div id="recent-activity" class="space-y-4">
                        <div class="flex items-center text-sm text-gray-600">
                            <i class="fas fa-user-plus mr-3 text-green-500"></i>
                            <span>Account created</span>
                        </div>
                        <div class="text-sm text-gray-500 text-center py-8">
                            <i class="fas fa-box-open text-3xl mb-2 block"></i>
                            No recent orders
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Scripts -->
    <script>
        console.log('üî• Dashboard page loaded');
        
        let currentUser = null;
        let supabase = null;
        
        // Wait for universal app and config to initialize
        function waitForUniversalApp() {
            return new Promise((resolve) => {
                const checkApp = () => {
                    if (window.supabase && window.VanHoolApp && window.CONFIG) {
                        supabase = window.supabase;
                        console.log('‚úÖ All dependencies loaded:', {
                            supabase: !!window.supabase,
                            vanHoolApp: !!window.VanHoolApp,
                            config: !!window.CONFIG
                        });
                        resolve();
                    } else {
                        console.log('‚è≥ Waiting for dependencies:', {
                            supabase: !!window.supabase,
                            vanHoolApp: !!window.VanHoolApp,
                            config: !!window.CONFIG
                        });
                        setTimeout(checkApp, 100);
                    }
                };
                checkApp();
            });
        }
        
        document.addEventListener('DOMContentLoaded', async function() {
            console.log('üìÑ DOM loaded, waiting for universal app...');
            await waitForUniversalApp();
            console.log('‚úÖ Universal app ready, checking auth');
            checkAuth();
            setupEventListeners();
        });
        
        async function checkAuth() {
            try {
                console.log('üîê Checking authentication...');
                
                if (!window.CONFIG || !window.CONFIG.supabase) {
                    console.error('‚ùå Supabase not properly initialized');
                    window.location.href = 'login.html';
                    return;
                }
                
                const { data: { session }, error } = await window.CONFIG.supabase.auth.getSession();
                
                if (error) {
                    console.error('Authentication error:', error);
                    window.location.href = 'login.html';
                    return;
                }
                
                if (!session) {
                    console.log('‚ùå Not authenticated, redirecting to login');
                    window.location.href = 'login.html';
                    return;
                }
                
                console.log('‚úÖ User authenticated:', session.user.email);
                currentUser = session.user;
                supabase = window.CONFIG.supabase; // Update local reference
                displayUserInfo(currentUser);
                loadUserData();
                
            } catch (error) {
                console.error('Auth check error:', error);
                window.location.href = 'login.html';
            }
        }
        
        function displayUserInfo(user) {
            document.getElementById('user-email').textContent = user.email;
            document.getElementById('user-name').textContent = user.email.split('@')[0];
            document.getElementById('welcome-message').textContent = `Welcome back, ${user.email}!`;
            
            const createdAt = new Date(user.created_at);
            document.getElementById('member-since').textContent = createdAt.toLocaleDateString();
        }
        
        async function loadUserData() {
            try {
                console.log('üìä Loading user dashboard data...');
                
                // Load profile data
                await loadProfileData();
                
                // Load orders data
                await loadOrdersData();
                
                // Load cart data
                await loadCartData();
                
                // Load wishlist data (if exists)
                await loadWishlistData();
                
                // Load recent activity
                await loadRecentActivity();
                
                console.log('‚úÖ Dashboard data loaded successfully');
                
            } catch (error) {
                console.error('Error loading user data:', error);
            }
        }
        
        async function loadProfileData() {
            try {
                console.log('üìù Loading profile data...');
                const { data: profile, error } = await supabase
                    .from('profiles')
                    .select('*')
                    .eq('id', currentUser.id)
                    .single();
                
                if (error && error.code !== 'PGRST116') {
                    console.error('Profile query error:', error);
                    return;
                }
                
                if (profile) {
                    console.log('‚úÖ Profile data loaded:', profile);
                    // Update full name if available
                    if (profile.first_name || profile.last_name || profile.full_name) {
                        const fullName = profile.full_name || 
                            `${profile.first_name || ''} ${profile.last_name || ''}`.trim();
                        const userFullNameEl = document.getElementById('user-full-name');
                        if (userFullNameEl) {
                            userFullNameEl.textContent = fullName;
                        }
                    }
                    
                    // Update phone if available
                    const phoneEl = document.getElementById('user-phone');
                    if (phoneEl && profile.phone) {
                        phoneEl.textContent = profile.phone;
                    }
                } else {
                    console.log('üìù No profile data found - user may need to complete profile');
                }
                
            } catch (error) {
                console.error('Error loading profile data:', error);
            }
        }
        
        async function loadOrdersData() {
            try {
                console.log('üì¶ Loading orders data...');
                const { data: orders, error } = await supabase
                    .from('orders')
                    .select('id, order_number, total_amount, status, created_at')
                    .eq('user_id', currentUser.id)
                    .order('created_at', { ascending: false });
                
                if (error) {
                    console.error('Error loading orders:', error);
                    // Set default state for orders
                    const ordersCountEl = document.getElementById('orders-count');
                    if (ordersCountEl) {
                        ordersCountEl.textContent = '0 orders';
                    }
                    return;
                }
                
                // Update orders count
                const ordersCountEl = document.getElementById('orders-count');
                if (ordersCountEl) {
                    const count = orders ? orders.length : 0;
                    ordersCountEl.textContent = `${count} order${count !== 1 ? 's' : ''}`;
                }
                
                console.log('üì¶ Loaded', orders?.length || 0, 'orders');
                
            } catch (error) {
                console.error('Error loading orders data:', error);
                // Set default state for orders
                const ordersCountEl = document.getElementById('orders-count');
                if (ordersCountEl) {
                    ordersCountEl.textContent = '0 orders';
                }
            }
        }
        
        async function loadCartData() {
            try {
                console.log('üõí Loading cart data...');
                const { data: cart, error } = await supabase
                    .from('carts')
                    .select(`
                        id,
                        cart_items (
                            quantity
                        )
                    `)
                    .eq('user_id', currentUser.id)
                    .eq('status', 'active')
                    .single();
                
                if (error && error.code !== 'PGRST116') {
                    console.error('Error loading cart:', error);
                    // Set default cart state
                    const cartCountEl = document.getElementById('cart-count');
                    if (cartCountEl) {
                        cartCountEl.textContent = '0';
                        cartCountEl.classList.add('hidden');
                    }
                    return;
                }
                
                // Update cart counter
                const totalItems = cart?.cart_items?.reduce((sum, item) => sum + item.quantity, 0) || 0;
                const cartCountEl = document.getElementById('cart-count');
                if (cartCountEl) {
                    cartCountEl.textContent = totalItems;
                    if (totalItems > 0) {
                        cartCountEl.classList.remove('hidden');
                    } else {
                        cartCountEl.classList.add('hidden');
                    }
                }
                
                console.log('üõí Cart items:', totalItems);
                
            } catch (error) {
                console.error('Error loading cart data:', error);
                // Set default cart state on error
                const cartCountEl = document.getElementById('cart-count');
                if (cartCountEl) {
                    cartCountEl.textContent = '0';
                    cartCountEl.classList.add('hidden');
                }
            }
        }
        
        async function loadWishlistData() {
            try {
                // For now, set wishlist to 0 as wishlist functionality isn't implemented yet
                const wishlistCountEl = document.getElementById('wishlist-count');
                if (wishlistCountEl) {
                    wishlistCountEl.textContent = '0 items';
                }
                
            } catch (error) {
                console.error('Error loading wishlist data:', error);
            }
        }
        
        async function loadRecentActivity() {
            try {
                console.log('üìà Loading recent activity...');
                // Load recent orders for activity
                const { data: recentOrders, error } = await supabase
                    .from('orders')
                    .select('id, order_number, total_amount, status, created_at')
                    .eq('user_id', currentUser.id)
                    .order('created_at', { ascending: false })
                    .limit(3);
                
                if (error) {
                    console.error('Error loading recent activity:', error);
                    // Still show account creation even if orders fail to load
                    const activityEl = document.getElementById('recent-activity');
                    if (activityEl) {
                        activityEl.innerHTML = `
                            <div class="flex items-center text-sm text-gray-600">
                                <i class="fas fa-user-plus mr-3 text-green-500"></i>
                                <span>Account created on ${new Date(currentUser.created_at).toLocaleDateString()}</span>
                            </div>
                            <div class="text-sm text-gray-500 text-center py-4">
                                <i class="fas fa-box-open text-3xl mb-2 block"></i>
                                No recent orders
                            </div>
                        `;
                    }
                    return;
                }
                
                const activityEl = document.getElementById('recent-activity');
                if (activityEl) {
                    let activityHTML = `
                        <div class="flex items-center text-sm text-gray-600">
                            <i class="fas fa-user-plus mr-3 text-green-500"></i>
                            <span>Account created on ${new Date(currentUser.created_at).toLocaleDateString()}</span>
                        </div>
                    `;
                    
                    if (recentOrders && recentOrders.length > 0) {
                        recentOrders.forEach(order => {
                            const orderDate = new Date(order.created_at).toLocaleDateString();
                            const statusIcon = order.status === 'completed' ? 'fas fa-check-circle text-green-500' :
                                             order.status === 'processing' ? 'fas fa-clock text-yellow-500' :
                                             'fas fa-shopping-bag text-red-500';
                            
                            activityHTML += `
                                <div class="flex items-center text-sm text-gray-600">
                                    <i class="${statusIcon} mr-3"></i>
                                    <span>Order #${order.order_number} - ‚Ç¨${order.total_amount} (${orderDate})</span>
                                </div>
                            `;
                        });
                    } else {
                        activityHTML += `
                            <div class="text-sm text-gray-500 text-center py-4">
                                <i class="fas fa-box-open text-3xl mb-2 block"></i>
                                No recent orders
                            </div>
                        `;
                    }
                    
                    activityEl.innerHTML = activityHTML;
                }
                
                console.log('üìà Recent activity loaded');
                
            } catch (error) {
                console.error('Error loading recent activity:', error);
                // Show default activity
                const activityEl = document.getElementById('recent-activity');
                if (activityEl) {
                    activityEl.innerHTML = `
                        <div class="flex items-center text-sm text-gray-600">
                            <i class="fas fa-user-plus mr-3 text-green-500"></i>
                            <span>Account created</span>
                        </div>
                        <div class="text-sm text-gray-500 text-center py-4">
                            <i class="fas fa-box-open text-3xl mb-2 block"></i>
                            Unable to load activity
                        </div>
                    `;
                }
            }
        }
        
        function setupEventListeners() {
            // User menu toggle
            const userMenuButton = document.getElementById('user-menu-button');
            const userDropdown = document.getElementById('user-dropdown');
            
            if (userMenuButton) {
                userMenuButton.addEventListener('click', () => {
                    userDropdown.classList.toggle('hidden');
                });
            }
            
            // Click outside to close dropdown
            document.addEventListener('click', (e) => {
                if (!userMenuButton?.contains(e.target)) {
                    userDropdown?.classList.add('hidden');
                }
            });
            
            // Logout
            const logoutBtn = document.getElementById('logout-btn');
            if (logoutBtn) {
                logoutBtn.addEventListener('click', async (e) => {
                    e.preventDefault();
                    await handleLogout();
                });
            }
        }
        
        async function handleLogout() {
            try {
                const { error } = await supabase.auth.signOut();
                if (error) {
                    console.error('Logout error:', error);
                }
                
                // Always redirect to home page
                window.location.href = 'index.html';
                
            } catch (error) {
                console.error('Logout failed:', error);
                // Still redirect even if logout fails
                window.location.href = 'index.html';
            }
        }
        
        function showError(message) {
            const errorDiv = document.createElement('div');
            errorDiv.className = 'fixed top-4 right-4 bg-red-500 text-white px-4 py-2 rounded-lg shadow-lg z-50';
            errorDiv.textContent = message;
            document.body.appendChild(errorDiv);
            
            setTimeout(() => {
                errorDiv.remove();
            }, 5000);
        }
    </script>
    
    <!-- Universal App System -->
    <script src="js/app-universal.js"></script>
    <script type="module" src="js/config.js"></script>
</body>
</html>