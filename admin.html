<!DOCTYPE html>
<html lang="ro">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Panou de Administrare - Piese Auto</title>
    <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <link href="css/custom-colors.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <style>
        /* Custom scrollbar styles for better visibility */
        .modal-content {
            scrollbar-width: thin;
            scrollbar-color: #cbd5e0 #f7fafc;
        }
        .modal-content::-webkit-scrollbar {
            width: 8px;
        }
        .modal-content::-webkit-scrollbar-track {
            background: #f7fafc;
            border-radius: 4px;
        }
        .modal-content::-webkit-scrollbar-thumb {
            background: #cbd5e0;
            border-radius: 4px;
        }
        .modal-content::-webkit-scrollbar-thumb:hover {
            background: #a0aec0;
        }
        
        /* Ensure proper modal positioning */
        .modal-wrapper {
            overflow-y: auto;
            overflow-x: hidden;
            max-height: 100vh;
            padding: 2rem 1rem;
        }
        
        .modal-content-container {
            max-height: calc(100vh - 4rem);
            display: flex;
            flex-direction: column;
        }
        
        .modal-scrollable {
            overflow-y: auto;
            flex: 1;
            min-height: 0;
        }
        
        /* Smooth transitions */
        .modal-wrapper, .modal-content {
            transition: all 0.2s ease-in-out;
        }
    </style>
</head>
<body class="bg-gray-100 min-h-screen">
    <!-- Header -->
    <header class="bg-white shadow-sm border-b">
        <div class="container mx-auto px-4 lg:px-8">
            <nav class="flex items-center justify-between h-16">
                <div class="flex items-center space-x-8">
                    <a href="index.html" class="text-xl font-bold text-gray-900 flex items-center">
                        <i class="fas fa-cog mr-2 text-gray-600"></i>
                        Panou Admin
                    </a>
                </div>
                
                <div class="flex items-center space-x-4">
                    <a href="index.html" class="text-gray-600 hover:text-gray-900 font-medium">√énapoi la Site</a>
                    <div id="admin-user-info" class="text-gray-600 font-medium"></div>
                </div>
            </nav>
        </div>
    </header>

    <!-- Main Content -->
    <div class="container mx-auto px-4 py-8">
        <!-- Admin Check -->
        <div id="admin-check" class="text-center py-12">
            <div class="animate-spin rounded-full h-12 w-12 border-b-2 border-purple-600 mx-auto mb-4"></div>
            <p class="text-gray-600">Checking admin access...</p>
        </div>
        
        <!-- Not Admin -->
        <div id="not-admin" class="hidden text-center py-12">
            <i class="fas fa-shield-alt text-red-500 text-4xl mb-4"></i>
            <h2 class="text-2xl font-bold text-gray-900 mb-4">Access Denied</h2>
            <p class="text-gray-600 mb-6">You don't have admin privileges for this system.</p>
            
            <div class="bg-red-50 border border-red-200 rounded-lg p-4 mb-6 max-w-md mx-auto">
                <h3 class="font-semibold text-red-800 mb-2">Need Admin Access?</h3>
                <p class="text-red-700 text-sm mb-3">Admin access is controlled via Supabase Auth metadata. Set your user metadata with <code>role: "admin"</code> or use the admin email.</p>
            </div>
            
            <a href="index.html" class="text-red-600 hover:text-red-700">‚Üê Back to Home</a>
        </div>
        
        <!-- Admin Dashboard -->
        <div id="admin-dashboard" class="hidden">
            <!-- Welcome -->
            <div class="bg-white rounded-lg p-8 shadow-sm border mb-8">
                <h1 class="text-3xl font-bold text-gray-900 mb-2">Panou de Administrare</h1>
                <p class="text-gray-600">GestioneazƒÉ magazinul tƒÉu de piese auto</p>
            </div>
            
            <!-- Stats Cards -->
            <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6 mb-8">
                <div class="bg-white rounded-lg shadow-sm border p-6">
                    <div class="flex items-center">
                        <div class="bg-gray-100 rounded-lg p-3 mr-4">
                            <i class="fas fa-box text-gray-600 text-xl"></i>
                        </div>
                        <div>
                            <p class="text-sm font-medium text-gray-500">Total Produse</p>
                            <p class="text-2xl font-bold text-gray-900" id="total-products">-</p>
                        </div>
                    </div>
                </div>
                
                <div class="bg-white rounded-lg shadow-sm border p-6">
                    <div class="flex items-center">
                        <div class="bg-gray-100 rounded-lg p-3 mr-4">
                            <i class="fas fa-users text-gray-600 text-xl"></i>
                        </div>
                        <div>
                            <p class="text-sm font-medium text-gray-500">Total Utilizatori</p>
                            <p class="text-2xl font-bold text-gray-900" id="total-users">-</p>
                        </div>
                    </div>
                </div>
                
                <div class="bg-white rounded-lg shadow-sm border p-6">
                    <div class="flex items-center">
                        <div class="bg-gray-100 rounded-lg p-3 mr-4">
                            <i class="fas fa-shopping-cart text-gray-600 text-xl"></i>
                        </div>
                        <div>
                            <p class="text-sm font-medium text-gray-500">Total Comenzi</p>
                            <p class="text-2xl font-bold text-gray-900" id="total-orders">-</p>
                        </div>
                    </div>
                </div>
                
                <div class="bg-white rounded-lg shadow-sm border p-6">
                    <div class="flex items-center">
                        <div class="bg-gray-100 rounded-lg p-3 mr-4">
                            <i class="fas fa-list text-gray-600 text-xl"></i>
                        </div>
                        <div>
                            <p class="text-sm font-medium text-gray-500">Categorii</p>
                            <p class="text-2xl font-bold text-gray-900" id="total-categories">-</p>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Ac»õiuni Rapide -->
            <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6 mb-8">
                <!-- Gestionare Produse -->
                <div class="bg-white rounded-lg shadow-sm border p-6 hover:shadow-md transition-shadow">
                    <div class="flex items-center mb-4">
                        <div class="bg-gray-100 rounded-lg p-3 mr-4">
                            <i class="fas fa-box text-gray-600 text-xl"></i>
                        </div>
                        <div>
                            <h3 class="text-lg font-semibold text-gray-900">Gestionare Produse</h3>
                            <p class="text-gray-500 text-sm">AdaugƒÉ, editeazƒÉ, »ôterge piese</p>
                        </div>
                    </div>
                    <button onclick="showProductManagement()" class="bg-gray-900 text-white px-4 py-2 rounded-lg hover:bg-gray-800 w-full transition-colors font-medium">
                        GestioneazƒÉ Produse
                    </button>
                </div>
                
                <!-- Gestionare Comenzi -->
                <div class="bg-white rounded-lg shadow-sm border p-6 hover:shadow-md transition-shadow">
                    <div class="flex items-center mb-4">
                        <div class="bg-gray-100 rounded-lg p-3 mr-4">
                            <i class="fas fa-shopping-cart text-gray-600 text-xl"></i>
                        </div>
                        <div>
                            <h3 class="text-lg font-semibold text-gray-900">Comenzi & PlƒÉ»õi</h3>
                            <p class="text-gray-500 text-sm">VizualizeazƒÉ comenzile »ôi plƒÉ»õile</p>
                        </div>
                    </div>
                    <button onclick="showOrderManagement()" class="bg-gray-900 text-white px-4 py-2 rounded-lg hover:bg-gray-800 w-full transition-colors font-medium">
                        VizualizeazƒÉ Comenzi
                    </button>
                </div>
                
                <!-- Gestionare Utilizatori -->
                <div class="bg-white rounded-lg shadow-sm border p-6 hover:shadow-md transition-shadow">
                    <div class="flex items-center mb-4">
                        <div class="bg-gray-100 rounded-lg p-3 mr-4">
                            <i class="fas fa-users text-gray-600 text-xl"></i>
                        </div>
                        <div>
                            <h3 class="text-lg font-semibold text-gray-900">Gestionare Utilizatori</h3>
                            <p class="text-gray-500 text-sm">AdministreazƒÉ utilizatorii</p>
                        </div>
                    </div>
                    <button onclick="showUserManagement()" class="bg-gray-900 text-white px-4 py-2 rounded-lg hover:bg-gray-800 w-full transition-colors font-medium">
                        GestioneazƒÉ Utilizatori
                    </button>
                </div>
                
                <!-- Coduri Promo»õionale -->
                <div class="bg-white rounded-lg shadow-sm border p-6 hover:shadow-md transition-shadow">
                    <div class="flex items-center mb-4">
                        <div class="bg-gray-100 rounded-lg p-3 mr-4">
                            <i class="fas fa-tags text-gray-600 text-xl"></i>
                        </div>
                        <div>
                            <h3 class="text-lg font-semibold text-gray-900">Coduri Promo»õionale</h3>
                            <p class="text-gray-500 text-sm">CreeazƒÉ »ôi urmƒÉre»ôte promo»õii</p>
                        </div>
                    </div>
                    <button onclick="showPromoCodeManagement()" class="bg-gray-900 text-white px-4 py-2 rounded-lg hover:bg-gray-800 w-full transition-colors font-medium">
                        GestioneazƒÉ Promo»õii
                    </button>
                </div>
                
                <!-- Gestionare Categorii -->
                <div class="bg-white rounded-lg shadow-sm border p-6 hover:shadow-md transition-shadow">
                    <div class="flex items-center mb-4">
                        <div class="bg-gray-100 rounded-lg p-3 mr-4">
                            <i class="fas fa-list text-gray-600 text-xl"></i>
                        </div>
                        <div>
                            <h3 class="text-lg font-semibold text-gray-900">Gestionare Categorii</h3>
                            <p class="text-gray-500 text-sm">OrganizeazƒÉ categoriile produselor</p>
                        </div>
                    </div>
                    <button onclick="showCategoriesManagement()" class="bg-gray-900 text-white px-4 py-2 rounded-lg hover:bg-gray-800 w-full transition-colors font-medium">
                        GestioneazƒÉ Categorii
                    </button>
                </div>
                
                <!-- AdƒÉugare RapidƒÉ Produs -->
                <div class="bg-white rounded-lg shadow-sm border p-6 hover:shadow-md transition-shadow">
                    <div class="flex items-center mb-4">
                        <div class="bg-gray-100 rounded-lg p-3 mr-4">
                            <i class="fas fa-plus-circle text-gray-600 text-xl"></i>
                        </div>
                        <div>
                            <h3 class="text-lg font-semibold text-gray-900">AdƒÉugare RapidƒÉ</h3>
                            <p class="text-gray-500 text-sm">AdaugƒÉ un produs nou rapid</p>
                        </div>
                    </div>
                    <button onclick="showAddProductForm()" class="bg-gray-900 text-white px-4 py-2 rounded-lg hover:bg-gray-800 w-full transition-colors font-medium">
                        AdaugƒÉ Produs
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Admin Modals -->
    
    <!-- Product Management Modal -->
    <div id="products-modal" class="hidden fixed inset-0 bg-black bg-opacity-50 z-50">
        <div class="flex items-center justify-center modal-wrapper">
            <div class="bg-white rounded-lg max-w-6xl w-full modal-content-container shadow-xl">
                <div class="p-6 border-b border-gray-200 flex-shrink-0">
                    <div class="flex justify-between items-center">
                        <h2 class="text-2xl font-bold text-gray-900">Product Management</h2>
                        <button onclick="closeModal('products-modal')" class="text-gray-400 hover:text-gray-600">
                            <i class="fas fa-times text-xl"></i>
                        </button>
                    </div>
                </div>
                <div class="p-6 modal-scrollable">
                    <div class="mb-4 flex justify-between items-center">
                        <div class="flex space-x-4">
                            <input type="text" id="product-search" placeholder="Search products..." class="px-4 py-2 border border-gray-300 rounded-lg">
                            <select id="product-category-filter" class="px-4 py-2 border border-gray-300 rounded-lg">
                                <option value="">All Categories</option>
                            </select>
                        </div>
                        <button onclick="showAddProductForm()" class="bg-red-600 text-white px-4 py-2 rounded hover:bg-red-700">
                            <i class="fas fa-plus mr-2"></i>Add New Product
                        </button>
                    </div>
                    <div id="products-list" class="space-y-4">
                        <!-- Products will be loaded here -->
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Add Product Modal -->
    <div id="add-product-modal" class="hidden fixed inset-0 bg-black bg-opacity-50 z-50">
        <div class="flex items-center justify-center modal-wrapper">
            <div class="bg-white rounded-lg max-w-4xl w-full modal-content-container shadow-xl">
                <div class="p-6 border-b border-gray-200 flex-shrink-0">
                    <div class="flex justify-between items-center">
                        <h2 class="text-2xl font-bold text-gray-900">Add New Product</h2>
                        <button onclick="closeModal('add-product-modal')" class="text-gray-400 hover:text-gray-600">
                            <i class="fas fa-times text-xl"></i>
                        </button>
                    </div>
                </div>
                <div class="p-6 modal-scrollable">
                    <form id="add-product-form" class="space-y-6">
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                            <!-- Basic Information -->
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">Part Code *</label>
                                <div class="flex space-x-2">
                                    <input type="text" name="part_code" required class="flex-1 px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-red-500" placeholder="VH-BP-F-AG300-001">
                                    <button type="button" onclick="generatePartCode()" class="px-3 py-2 bg-gray-100 text-gray-600 border border-gray-300 rounded-lg hover:bg-gray-200 text-sm">
                                        Auto
                                    </button>
                                </div>
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">Main Category *</label>
                                <select required class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-red-500" id="parent-category-select" onchange="loadSubcategories(this.value)">
                                    <option value="">Select Main Category</option>
                                </select>
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">Subcategory *</label>
                                <select name="category_id" required class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-red-500" id="subcategory-select" disabled>
                                    <option value="">First select main category</option>
                                </select>
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">Name (English) *</label>
                                <input type="text" name="name_en" required class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-red-500">
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">Name (Moldovan)</label>
                                <input type="text" name="name_ro" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-red-500">
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">Name (Russian)</label>
                                <input type="text" name="name_ru" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-red-500">
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">Price (EUR) *</label>
                                <input type="number" name="price" required step="0.01" min="0" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-red-500">
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">Stock Quantity *</label>
                                <input type="number" name="stock_quantity" required min="0" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-red-500">
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">Image URL</label>
                                <input type="url" name="image_url" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-red-500" placeholder="https://example.com/image.jpg">
                            </div>
                        </div>
                        
                        <!-- Additional Details Checkbox -->
                        <div class="flex items-center">
                            <input type="checkbox" id="include-details" class="rounded border-gray-300 text-red-600 focus:ring-red-500">
                            <label for="include-details" class="ml-2 text-sm text-gray-700">Include description and specifications</label>
                        </div>
                        
                        <!-- Additional Details Section -->
                        <div id="additional-details" class="hidden space-y-4">
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">Description (English)</label>
                                <textarea name="description_en" rows="3" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-red-500"></textarea>
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">Description (Moldovan)</label>
                                <textarea name="description_ro" rows="3" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-red-500"></textarea>
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">Description (Russian)</label>
                                <textarea name="description_ru" rows="3" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-red-500"></textarea>
                            </div>
                            
                            <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-2">Weight (kg)</label>
                                    <input type="number" name="weight" step="0.01" min="0" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-red-500">
                                </div>
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-2">Width (cm)</label>
                                    <input type="number" name="width" step="0.1" min="0" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-red-500">
                                </div>
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-2">Height (cm)</label>
                                    <input type="number" name="height" step="0.1" min="0" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-red-500">
                                </div>
                            </div>
                        </div>
                        
                        <div class="flex justify-end space-x-4">
                            <button type="button" onclick="closeModal('add-product-modal')" class="px-4 py-2 text-gray-700 bg-gray-200 rounded hover:bg-gray-300">
                                Cancel
                            </button>
                            <button type="submit" id="add-product-submit" class="px-6 py-2 bg-red-600 text-white rounded hover:bg-red-700 disabled:opacity-50 disabled:cursor-not-allowed">
                                <span class="add-product-text">Add Product</span>
                                <span class="add-product-loading hidden">
                                    <i class="fas fa-spinner fa-spin mr-2"></i>Adding...
                                </span>
                            </button>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>

    <!-- Edit Product Modal -->
    <div id="edit-product-modal" class="hidden fixed inset-0 bg-black bg-opacity-50 z-50">
        <div class="flex items-center justify-center modal-wrapper">
            <div class="bg-white rounded-lg max-w-4xl w-full modal-content-container shadow-xl">
                <div class="p-6 border-b border-gray-200 flex-shrink-0">
                    <div class="flex justify-between items-center">
                        <h2 class="text-2xl font-bold text-gray-900">Edit Product</h2>
                        <button onclick="closeModal('edit-product-modal')" class="text-gray-400 hover:text-gray-600">
                            <i class="fas fa-times text-xl"></i>
                        </button>
                    </div>
                </div>
                <div class="p-6 modal-scrollable">
                    <form id="edit-product-form" class="space-y-6">
                        <input type="hidden" name="product_id" id="edit-product-id">
                        
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                            <!-- Basic Information -->
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">Part Code *</label>
                                <input type="text" name="part_code" id="edit-part-code" required class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-red-500" placeholder="VH-BP-F-AG300-001">
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">Main Category *</label>
                                <select id="edit-parent-category" required class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-red-500" onchange="loadEditSubcategories(this.value)">
                                    <option value="">Select Main Category</option>
                                </select>
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">Subcategory *</label>
                                <select name="category_id" id="edit-subcategory" required class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-red-500" disabled>
                                    <option value="">First select main category</option>
                                </select>
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">Name (English) *</label>
                                <input type="text" name="name_en" id="edit-name-en" required class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-red-500" placeholder="Brake Pad Set">
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">Name (Moldovan)</label>
                                <input type="text" name="name_ro" id="edit-name-ro" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-red-500" placeholder="Set PlƒÉcu»õe Fr√¢nƒÉ">
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">Name (Russian)</label>
                                <input type="text" name="name_ru" id="edit-name-ru" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-red-500" placeholder="–ö–æ–º–ø–ª–µ–∫—Ç —Ç–æ—Ä–º–æ–∑–Ω—ã—Ö –∫–æ–ª–æ–¥–æ–∫">
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">Price *</label>
                                <input type="number" name="price" id="edit-price" step="0.01" required class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-red-500" placeholder="99.99">
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">Stock Quantity *</label>
                                <input type="number" name="stock_quantity" id="edit-stock-quantity" required class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-red-500" placeholder="10">
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">Image URL</label>
                                <input type="url" name="image_url" id="edit-image-url" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-red-500" placeholder="https://example.com/image.jpg">
                            </div>
                        </div>

                        <!-- Optional Specifications Checkbox -->
                        <div class="border-t pt-6">
                            <div class="flex items-center mb-4">
                                <input type="checkbox" id="edit-enable-specs" class="mr-2">
                                <label for="edit-enable-specs" class="text-sm font-medium text-gray-700">Add detailed specifications</label>
                            </div>
                            
                            <div id="edit-optional-specs" class="hidden grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-2">SKU</label>
                                    <input type="text" name="sku" id="edit-sku" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-red-500" placeholder="VH-SKU-001">
                                </div>
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-2">Brand</label>
                                    <input type="text" name="brand" id="edit-brand" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-red-500" placeholder="Van Hool">
                                </div>
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-2">Weight (kg)</label>
                                    <input type="number" name="weight" id="edit-weight" step="0.001" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-red-500" placeholder="2.5">
                                </div>
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-2">Width (cm)</label>
                                    <input type="number" name="width" id="edit-width" step="0.01" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-red-500" placeholder="15.5">
                                </div>
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-2">Height (cm)</label>
                                    <input type="number" name="height" id="edit-height" step="0.01" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-red-500" placeholder="8.2">
                                </div>
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-2">Warranty (months)</label>
                                    <input type="number" name="warranty_months" id="edit-warranty-months" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-red-500" placeholder="12">
                                </div>
                            </div>
                        </div>

                        <!-- Descriptions -->
                        <div class="border-t pt-6">
                            <h3 class="text-lg font-medium text-gray-900 mb-4">Product Descriptions</h3>
                            <div class="grid grid-cols-1 gap-6">
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-2">Description (English)</label>
                                    <textarea name="description_en" id="edit-description-en" rows="3" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-red-500" placeholder="Product description in English"></textarea>
                                </div>
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-2">Description (Moldovan)</label>
                                    <textarea name="description_ro" id="edit-description-ro" rows="3" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-red-500" placeholder="Descrierea produsului √Æn rom√¢nƒÉ"></textarea>
                                </div>
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-2">Description (Russian)</label>
                                    <textarea name="description_ru" id="edit-description-ru" rows="3" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-red-500" placeholder="–û–ø–∏—Å–∞–Ω–∏–µ —Ç–æ–≤–∞—Ä–∞ –Ω–∞ —Ä—É—Å—Å–∫–æ–º —è–∑—ã–∫–µ"></textarea>
                                </div>
                            </div>
                        </div>

                        <div class="flex justify-end space-x-4 border-t pt-6">
                            <button type="button" onclick="closeModal('edit-product-modal')" class="px-4 py-2 text-gray-700 bg-gray-200 rounded hover:bg-gray-300">
                                Cancel
                            </button>
                            <button type="submit" class="px-6 py-2 bg-red-600 text-white rounded hover:bg-red-700">
                                Update Product
                            </button>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>

    <!-- Promo Codes Modal -->
    <div id="promo-codes-modal" class="hidden fixed inset-0 bg-black bg-opacity-50 z-50">
        <div class="flex items-center justify-center modal-wrapper">
            <div class="bg-white rounded-lg max-w-6xl w-full modal-content-container shadow-xl">
                <div class="p-6 border-b border-gray-200 flex-shrink-0">
                    <div class="flex justify-between items-center">
                        <h2 class="text-2xl font-bold text-gray-900">Promo Code Management</h2>
                        <button onclick="closeModal('promo-codes-modal')" class="text-gray-400 hover:text-gray-600">
                            <i class="fas fa-times text-xl"></i>
                        </button>
                    </div>
                </div>
                <div class="p-6 modal-scrollable">
                    <!-- Create New Promo Code -->
                    <div class="bg-gray-50 rounded-lg p-6 mb-6">
                        <h3 class="text-lg font-semibold text-gray-900 mb-4">Create New Promo Code</h3>
                        <form id="create-promo-form" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4">
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">Promo Code</label>
                                <input type="text" name="code" required class="w-full px-3 py-2 border border-gray-300 rounded-lg" placeholder="SAVE20">
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">Discount (%)</label>
                                <input type="number" name="discount_percent" required min="1" max="100" class="w-full px-3 py-2 border border-gray-300 rounded-lg" placeholder="20">
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">Max Uses</label>
                                <input type="number" name="max_uses" required min="1" class="w-full px-3 py-2 border border-gray-300 rounded-lg" placeholder="100">
                            </div>
                            <div class="flex items-end">
                                <button type="submit" class="w-full bg-green-600 text-white px-4 py-2 rounded hover:bg-green-700">
                                    Create Promo
                                </button>
                            </div>
                        </form>
                    </div>
                    
                    <!-- Existing Promo Codes -->
                    <div id="promo-codes-list">
                        <!-- Promo codes will be loaded here -->
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Orders Modal -->
    <div id="orders-modal" class="hidden fixed inset-0 bg-black bg-opacity-50 z-50">
        <div class="flex items-center justify-center modal-wrapper">
            <div class="bg-white rounded-lg max-w-7xl w-full modal-content-container shadow-xl">
                <div class="p-6 border-b border-gray-200 flex-shrink-0">
                    <div class="flex justify-between items-center">
                        <h2 class="text-2xl font-bold text-gray-900">Order Management</h2>
                        <button onclick="closeModal('orders-modal')" class="text-gray-400 hover:text-gray-600">
                            <i class="fas fa-times text-xl"></i>
                        </button>
                    </div>
                </div>
                <div class="p-6 modal-scrollable">
                    <div class="mb-4 flex justify-between items-center">
                        <div class="flex space-x-4">
                            <input type="text" id="order-search" placeholder="Search orders..." class="px-4 py-2 border border-gray-300 rounded-lg">
                            <select id="order-status-filter" class="px-4 py-2 border border-gray-300 rounded-lg">
                                <option value="">All Statuses</option>
                                <option value="pending">Pending</option>
                                <option value="processing">Processing</option>
                                <option value="shipped">Shipped</option>
                                <option value="delivered">Delivered</option>
                                <option value="cancelled">Cancelled</option>
                            </select>
                        </div>
                    </div>
                    <div id="orders-list">
                        <!-- Orders will be loaded here -->
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Users Modal -->
    <div id="users-modal" class="hidden fixed inset-0 bg-black bg-opacity-50 z-50">
        <div class="flex items-start justify-center min-h-screen p-4 pt-8 pb-8 modal-wrapper">
            <div class="bg-white rounded-lg max-w-6xl w-full max-h-[85vh] flex flex-col shadow-xl">
                <div class="p-6 border-b border-gray-200 flex-shrink-0">
                    <div class="flex justify-between items-center">
                        <h2 class="text-2xl font-bold text-gray-900">User Management</h2>
                        <button onclick="closeModal('users-modal')" class="text-gray-400 hover:text-gray-600">
                            <i class="fas fa-times text-xl"></i>
                        </button>
                    </div>
                </div>
                <div class="p-6 flex-1 overflow-y-auto min-h-0 modal-content">
                    <div class="mb-4">
                        <input type="text" id="user-search" placeholder="Search users..." class="px-4 py-2 border border-gray-300 rounded-lg">
                    </div>
                    <div id="users-list">
                        <!-- Users will be loaded here -->
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Categories Modal -->
    <div id="categories-modal" class="hidden fixed inset-0 bg-black bg-opacity-50 z-50">
        <div class="flex items-center justify-center modal-wrapper">
            <div class="bg-white rounded-lg max-w-6xl w-full modal-content-container shadow-xl">
                <div class="p-6 border-b border-gray-200 flex-shrink-0">
                    <div class="flex justify-between items-center">
                        <h2 class="text-2xl font-bold text-gray-900">Category Management</h2>
                        <button onclick="closeModal('categories-modal')" class="text-gray-400 hover:text-gray-600">
                            <i class="fas fa-times text-xl"></i>
                        </button>
                    </div>
                </div>
                <div class="p-6 modal-scrollable">
                    <div id="categories-management-content">
                        <!-- Categories content will be loaded here -->
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Edit Category Modal -->
    <div id="edit-category-modal" class="hidden fixed inset-0 bg-black bg-opacity-50 z-50">
        <div class="flex items-center justify-center modal-wrapper">
            <div class="bg-white rounded-lg max-w-2xl w-full modal-content-container shadow-xl">
                <div class="p-6 border-b border-gray-200 flex-shrink-0">
                    <div class="flex justify-between items-center">
                        <h2 class="text-2xl font-bold text-gray-900">Edit Category</h2>
                        <button onclick="closeModal('edit-category-modal')" class="text-gray-400 hover:text-gray-600">
                            <i class="fas fa-times text-xl"></i>
                        </button>
                    </div>
                </div>
                <div class="p-6 modal-scrollable">
                    <form id="edit-category-form" class="space-y-6">
                        <input type="hidden" id="edit-category-id" name="category_id">
                        
                        <div class="grid grid-cols-1 gap-6">
                            <!-- Category Type -->
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">Category Type</label>
                                <div class="flex space-x-4">
                                    <label class="flex items-center">
                                        <input type="radio" name="category_type" value="main" class="mr-2">
                                        <span>Main Category</span>
                                    </label>
                                    <label class="flex items-center">
                                        <input type="radio" name="category_type" value="sub" class="mr-2">
                                        <span>Subcategory</span>
                                    </label>
                                </div>
                            </div>

                            <!-- Parent Category (for subcategories) -->
                            <div id="parent-category-section" class="hidden">
                                <label class="block text-sm font-medium text-gray-700 mb-2">Parent Category *</label>
                                <select id="edit-parent-category" name="parent_id" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-red-500">
                                    <option value="">Select Parent Category</option>
                                </select>
                            </div>
                            
                            <!-- Names -->
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">Name (English) *</label>
                                <input type="text" id="edit-category-name-en" name="name_en" required class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-red-500">
                            </div>
                            
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">Name (Moldovan)</label>
                                <input type="text" id="edit-category-name-ro" name="name_ro" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-red-500">
                            </div>
                            
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">Name (Russian)</label>
                                <input type="text" id="edit-category-name-ru" name="name_ru" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-red-500">
                            </div>
                            
                            <!-- Slug -->
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">Slug *</label>
                                <input type="text" id="edit-category-slug" name="slug" required class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-red-500" placeholder="category-slug">
                                <p class="text-xs text-gray-500 mt-1">URL-friendly version (lowercase, no spaces)</p>
                            </div>
                            
                            <!-- Description -->
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">Description</label>
                                <textarea id="edit-category-description" name="description" rows="3" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-red-500" placeholder="Category description..."></textarea>
                            </div>
                            
                            <!-- Sort Order -->
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">Sort Order</label>
                                <input type="number" id="edit-category-sort-order" name="sort_order" min="0" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-red-500" placeholder="0">
                                <p class="text-xs text-gray-500 mt-1">Lower numbers appear first</p>
                            </div>
                            
                            <!-- Status -->
                            <div class="flex items-center">
                                <input type="checkbox" id="edit-category-active" name="is_active" class="rounded border-gray-300 text-red-600 focus:ring-red-500">
                                <label for="edit-category-active" class="ml-2 text-sm text-gray-700">Active</label>
                            </div>
                        </div>
                        
                        <div class="flex justify-end space-x-4">
                            <button type="button" onclick="closeModal('edit-category-modal')" class="px-6 py-2 border border-gray-300 rounded-lg text-gray-700 hover:bg-gray-50">
                                Cancel
                            </button>
                            <button type="submit" class="px-6 py-2 bg-red-600 text-white rounded-lg hover:bg-red-700">
                                <span class="update-category-text">Update Category</span>
                                <span class="update-category-loading hidden">
                                    <i class="fas fa-spinner fa-spin mr-2"></i>Updating...
                                </span>
                            </button>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>

    <!-- Universal App System -->
    <script src="js/app-universal.js"></script>
    <script type="module" src="js/config.js"></script>
    
    <script>
        console.log('üî• Admin panel loaded');
        
        // Helper to get Supabase client
        async function getSupabaseClient() {
            let supabaseClient = window.supabase || window.CONFIG?.supabase;
            let attempts = 0;
            while (!supabaseClient && attempts < 50) {
                await new Promise(resolve => setTimeout(resolve, 100));
                supabaseClient = window.supabase || window.CONFIG?.supabase;
                attempts++;
            }
            if (!supabaseClient) {
                throw new Error('Database connection not available. Please refresh the page.');
            }
            return supabaseClient;
        }
        
        // Simple admin access check using Supabase Auth
        async function checkAdminAccess() {
            try {
                const supabase = await getSupabaseClient();
                const { data: { session }, error } = await supabase.auth.getSession();
                
                if (!session || !session.user) {
                    // Not logged in - redirect to login
                    window.location.href = 'login.html?redirect=' + encodeURIComponent(window.location.href);
                    return;
                }
                
                document.getElementById('admin-check').classList.add('hidden');
                
                // Check if user is admin (add your email addresses here)
                const user = session.user;
                const adminEmails = [
                    'bobernagadamianw2312@gmail.com',
                    'tbobernaga@gmail.com',
                    // Add your email here:
                    // 'your-email@gmail.com',
                ];
                
                // Also check database is_admin flag
                let isAdmin = adminEmails.includes(user.email);
                
                // Check profile table for admin flag
                try {
                    const { data: profile, error: profileError } = await window.supabase
                        .from('profiles')
                        .select('is_admin')
                        .eq('id', user.id)
                        .single();
                    
                    if (profile && profile.is_admin) {
                        isAdmin = true;
                    }
                } catch (e) {
                    console.log('Could not check profile admin status:', e);
                }
                
                console.log('Admin check:', {
                    userEmail: user.email,
                    adminEmails: adminEmails,
                    isAdmin: isAdmin
                });
                
                if (!isAdmin) {
                    // Not an admin - show access denied
                    document.getElementById('not-admin').classList.remove('hidden');
                    console.log('User is not admin. Email:', user.email);
                    return;
                }
                
                // User is admin - show dashboard
                document.getElementById('admin-dashboard').classList.remove('hidden');
                const userName = user.user_metadata?.full_name || 
                                user.user_metadata?.name || 
                                user.email.split('@')[0];
                document.getElementById('admin-user-info').textContent = `Welcome, ${userName}`;
                
                // Load admin data
                loadAdminStats();
                
            } catch (error) {
                console.error('Admin access check error:', error);
                document.getElementById('admin-check').classList.add('hidden');
                document.getElementById('not-admin').classList.remove('hidden');
            }
        }
        
        // Load admin statistics
        async function loadAdminStats() {
            try {
                // Get product count
                let productCount = 0;
                try {
                    const { count } = await window.supabase
                        .from('products')
                        .select('*', { count: 'exact', head: true });
                    productCount = count || 0;
                } catch (e) {
                    console.log('Products table not found, using 0');
                }
                document.getElementById('total-products').textContent = productCount;
                
                // Get user count - use multiple approaches
                let userCount = 0;
                
                // Method 1: Try to count from orders table (users who have placed orders)
                try {
                    console.log('üîç Counting users from orders table...');
                    const { data: orders, error: ordersError } = await window.supabase
                        .from('orders')
                        .select('user_id');
                    
                    if (!ordersError && orders) {
                        // Get unique user IDs from orders
                        const uniqueUserIds = [...new Set(orders.map(order => order.user_id))];
                        userCount = uniqueUserIds.length;
                        console.log(`‚úÖ Found ${userCount} unique users from orders`);
                    }
                } catch (e) {
                    console.warn('‚ö†Ô∏è Cannot count from orders table');
                }
                
                // Method 2: If no users from orders, try profiles table
                if (userCount === 0) {
                    try {
                        console.log('üîç Trying profiles table with simple select...');
                        const { data: users, error: profilesError } = await window.supabase
                            .from('profiles')
                            .select('id');
                        
                        if (!profilesError && users) {
                            userCount = users.length;
                            console.log(`‚úÖ Found ${userCount} users from profiles table`);
                        }
                    } catch (e) {
                        console.warn('‚ö†Ô∏è Cannot access profiles table');
                    }
                }
                
                // Method 3: Fallback - at minimum we know there's the current admin user
                if (userCount === 0) {
                    console.log('üîç Using fallback user count...');
                    // If we can't count users but we're logged in as admin, 
                    // there's at least 1 user (the current user)
                    if (window.authManager && window.authManager.isAuthenticated()) {
                        userCount = 1;
                        console.log(`‚úÖ Fallback: At least ${userCount} user (current admin)`);
                    }
                }
                
                document.getElementById('total-users').textContent = userCount;
                console.log(`üìä Final user count displayed: ${userCount}`);
                
                // Get category count
                let categoryCount = 0;
                try {
                    const { count } = await window.supabase
                        .from('categories')
                        .select('*', { count: 'exact', head: true });
                    categoryCount = count || 0;
                } catch (e) {
                    console.log('Categories table not found, using 0');
                }
                document.getElementById('total-categories').textContent = categoryCount;
                
                // Get order count
                let orderCount = 0;
                try {
                    const { count } = await window.supabase
                        .from('orders')
                        .select('*', { count: 'exact', head: true });
                    orderCount = count || 0;
                } catch (e) {
                    console.log('Orders table not found, using 0');
                }
                document.getElementById('total-orders').textContent = orderCount;
                
            } catch (error) {
                console.error('Error loading admin stats:', error);
                // Set default values if all fails
                document.getElementById('total-products').textContent = '0';
                document.getElementById('total-users').textContent = window.authManager?.isAuthenticated() ? '1' : '0';
                document.getElementById('total-categories').textContent = '0';
                document.getElementById('total-orders').textContent = '0';
            }
        }
        
        
        // Admin action functions
        window.showAddProductForm = function() {
            showModal('add-product-modal');
        };
        
        window.showCategoriesManagement = function() {
            showModal('categories-modal');
            loadCategoriesForManagement();
        };
        
        
        window.showPromoCodeManagement = function() {
            showModal('promo-codes-modal');
            loadPromoCodes();
        };
        
        window.showOrderManagement = function() {
            showModal('orders-modal');
            loadOrders();
        };
        
        window.showUserManagement = function() {
            showModal('users-modal');
            loadUsers();
        };
        
        window.showProductManagement = function() {
            showModal('products-modal');
            loadProductsForManagement();
        };
        
        // Modal management
        function showModal(modalId) {
            document.getElementById(modalId).classList.remove('hidden');
            document.body.classList.add('overflow-hidden');
        }
        
        function closeModal(modalId) {
            document.getElementById(modalId).classList.add('hidden');
            document.body.classList.remove('overflow-hidden');
        }
        
        // Admin access management
        window.becomeAdmin = async function() {
            try {
                const { data: { session } } = await window.supabase.auth.getSession();
                if (!session || !session.user) {
                    alert('Please log in first');
                    return;
                }
                
                const { error } = await window.supabase
                    .from('profiles')
                    .update({ is_admin: true })
                    .eq('id', session.user.id);
                
                if (error) throw error;
                alert('Admin access granted! Please refresh the page.');
                window.location.reload();
            } catch (error) {
                console.error('Error granting admin:', error);
                alert('Failed to grant admin access');
            }
        };
        
        window.revokeAdmin = async function() {
            try {
                const { data: { session } } = await window.supabase.auth.getSession();
                if (!session || !session.user) return;
                
                const { error } = await window.supabase
                    .from('profiles')
                    .update({ is_admin: false })
                    .eq('id', session.user.id);
                
                if (error) throw error;
                alert('Admin access revoked! Redirecting...');
                window.location.href = 'index.html';
            } catch (error) {
                console.error('Error revoking admin:', error);
            }
        };
        
        // Load products for management
        async function loadProductsForManagement() {
            try {
                const { data: products, error } = await window.supabase
                    .from('products')
                    .select(`
                        *,
                        categories (name_en, name_ro, name_ru)
                    `)
                    .order('created_at', { ascending: false });
                
                const productsList = document.getElementById('products-list');
                
                if (error || !products || products.length === 0) {
                    productsList.innerHTML = '<p class="text-gray-500 text-center py-8">No products found</p>';
                    return;
                }
                
                productsList.innerHTML = products.map(product => `
                    <div class="bg-white border rounded-lg p-4">
                        <div class="flex justify-between items-start">
                            <div class="flex-1">
                                <div class="flex items-center space-x-4 mb-2">
                                    <span class="text-sm font-mono text-red-600">${product.part_code}</span>
                                    <span class="px-2 py-1 text-xs rounded ${product.is_active ? 'bg-green-100 text-green-800' : 'bg-red-100 text-red-800'}">
                                        ${product.is_active ? 'Active' : 'Inactive'}
                                    </span>
                                    ${product.is_featured ? '<span class="px-2 py-1 text-xs rounded bg-yellow-100 text-yellow-800">Featured</span>' : ''}
                                </div>
                                <h3 class="font-semibold text-gray-900 mb-1">${product.name_en}</h3>
                                <p class="text-sm text-gray-600 mb-2">Category: ${product.categories?.name_en || 'No category'}</p>
                                <div class="flex items-center space-x-4 text-sm text-gray-500">
                                    <span>‚Ç¨${product.price}</span>
                                    <span>Stock: ${product.stock_quantity}</span>
                                    <span>Created: ${new Date(product.created_at).toLocaleDateString()}</span>
                                </div>
                            </div>
                            <div class="flex space-x-2">
                                <button onclick="editProduct('${product.id}')" class="px-3 py-1 text-sm bg-red-600 text-white rounded hover:bg-red-700">
                                    Edit
                                </button>
                                <button onclick="deleteProduct('${product.id}')" class="px-3 py-1 text-sm bg-red-600 text-white rounded hover:bg-red-700">
                                    Delete
                                </button>
                            </div>
                        </div>
                    </div>
                `).join('');
                
            } catch (error) {
                console.error('Error loading products:', error);
            }
        }
        
        // Load promo codes
        async function loadPromoCodes() {
            try {
                const promoCodesList = document.getElementById('promo-codes-list');
                
                // First try to load promo codes with simple query
                const { data: promoCodes, error } = await window.supabase
                    .from('promocodes')
                    .select('*')
                    .order('created_at', { ascending: false });
                
                if (error) {
                    console.error('Error loading promo codes:', error);
                    promoCodesList.innerHTML = `<p class="text-red-500 text-center py-8">Error loading promo codes: ${error.message}</p>`;
                    return;
                }
                
                if (!promoCodes || promoCodes.length === 0) {
                    promoCodesList.innerHTML = '<p class="text-gray-500 text-center py-8">No promo codes found. Create your first promo code above!</p>';
                    return;
                }
                
                promoCodesList.innerHTML = promoCodes.map(promo => {
                    const usageCount = promo.current_uses || 0;
                    const maxUses = promo.max_uses || 1;
                    const usagePercentage = (usageCount / maxUses) * 100;
                    const isMaxedOut = usageCount >= maxUses;
                    const canBeEnabled = !isMaxedOut;
                    
                    // Status determination
                    let statusText = 'Active';
                    let statusClass = 'bg-green-100 text-green-800';
                    
                    if (!promo.is_active && isMaxedOut) {
                        statusText = 'Limit Reached';
                        statusClass = 'bg-orange-100 text-orange-800';
                    } else if (!promo.is_active) {
                        statusText = 'Disabled';
                        statusClass = 'bg-red-100 text-red-800';
                    } else if (isMaxedOut) {
                        statusText = 'At Limit';
                        statusClass = 'bg-yellow-100 text-yellow-800';
                    }
                    
                    return `
                        <div class="bg-white border rounded-lg p-4 mb-4 ${isMaxedOut ? 'border-orange-200 bg-orange-50' : ''}">
                            <div class="flex justify-between items-start mb-4">
                                <div class="flex-1">
                                    <div class="flex items-center space-x-3 mb-2">
                                        <span class="text-lg font-mono font-bold text-gray-900">${promo.code}</span>
                                        <span class="px-2 py-1 text-sm rounded ${statusClass}">
                                            ${statusText}
                                        </span>
                                        ${isMaxedOut ? '<span class="px-2 py-1 text-xs bg-orange-200 text-orange-800 rounded-full">üö´ Usage Limit Reached</span>' : ''}
                                    </div>
                                    <p class="text-gray-600">
                                        ${promo.discount_percent || 0}% discount ‚Ä¢ Used ${usageCount}/${maxUses} times
                                    </p>
                                    <p class="text-sm text-gray-500">Created: ${new Date(promo.created_at).toLocaleDateString()}</p>
                                    ${isMaxedOut ? '<p class="text-sm text-orange-600 font-medium mt-1">‚ö†Ô∏è This promocode cannot be used anymore (automatically disabled)</p>' : ''}
                                </div>
                                <div class="flex flex-col space-y-2 ml-4">
                                    ${canBeEnabled ? `
                                        <button onclick="togglePromoCode('${promo.id}', ${!promo.is_active})" 
                                                class="px-3 py-1 text-sm ${promo.is_active ? 'bg-red-600 hover:bg-red-700' : 'bg-green-600 hover:bg-green-700'} text-white rounded">
                                            ${promo.is_active ? 'Deactivate' : 'Activate'}
                                        </button>
                                    ` : `
                                        <button disabled class="px-3 py-1 text-sm bg-gray-300 text-gray-500 rounded cursor-not-allowed" 
                                                title="Cannot enable - usage limit reached">
                                            Maxed Out
                                        </button>
                                    `}
                                    <button onclick="deletePromoCode('${promo.id}')" 
                                            class="px-3 py-1 text-sm bg-gray-600 text-white rounded hover:bg-gray-700">
                                        Delete
                                    </button>
                                    <button onclick="refreshPromoCodes()" 
                                            class="px-2 py-1 text-xs bg-blue-100 text-blue-600 rounded hover:bg-blue-200"
                                            title="Refresh usage counts">
                                        <i class="fas fa-sync-alt"></i>
                                    </button>
                                </div>
                            </div>
                            
                            <!-- Usage Progress Bar -->
                            <div class="mb-3">
                                <div class="flex justify-between text-sm text-gray-600 mb-1">
                                    <span>Usage Progress</span>
                                    <span>${usagePercentage.toFixed(1)}%</span>
                                </div>
                                <div class="w-full bg-gray-200 rounded-full h-3">
                                    <div class="${usageCount >= maxUses ? 'bg-red-500' : usageCount/maxUses > 0.8 ? 'bg-yellow-500' : 'bg-blue-500'} h-3 rounded-full transition-all duration-300" 
                                         style="width: ${Math.min(usagePercentage, 100)}%"></div>
                                </div>
                                <div class="flex justify-between items-center mt-1">
                                    <span class="text-xs text-gray-500">${usageCount}/${maxUses} uses</span>
                                    ${isMaxedOut ? '<span class="text-xs text-red-600 font-medium">LIMIT REACHED</span>' : ''}
                                </div>
                            </div>
                        </div>
                    `;
                }).join('');
                
            } catch (error) {
                console.error('Error loading promo codes:', error);
            }
        }
        
        // Load orders
        async function loadOrders() {
            try {
                const { data: orders, error } = await window.supabase
                    .from('orders')
                    .select('*')
                    .order('created_at', { ascending: false })
                    .limit(50);

                if (error) {
                    console.error('Error loading orders:', error);
                    throw error;
                }

                const ordersList = document.getElementById('orders-list');
                
                if (!orders || orders.length === 0) {
                    ordersList.innerHTML = '<p class="text-gray-500 text-center py-8">No orders found</p>';
                    return;
                }

                ordersList.innerHTML = orders.map(order => {
                    const items = order.items || [];
                    const totalItems = items.reduce((sum, item) => sum + (item.quantity || 0), 0);
                    
                    return `
                        <div class="bg-white border rounded-lg p-6 hover:shadow-md transition-shadow cursor-pointer" onclick="viewOrderDetails('${order.id}')">
                            <div class="flex justify-between items-start mb-4">
                                <div class="flex-1">
                                    <div class="flex items-center space-x-4 mb-2">
                                        <h3 class="font-semibold text-gray-900">#${order.id.slice(-8)}</h3>
                                        <span class="px-2 py-1 text-xs rounded-full ${getOrderStatusColor(order.status)}">
                                            ${(order.status || 'pending').charAt(0).toUpperCase() + (order.status || 'pending').slice(1)}
                                        </span>
                                    </div>
                                    <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                                        <div>
                                            <h4 class="font-medium text-gray-700">Customer:</h4>
                                            <p class="text-sm text-gray-600">${order.customer_name || 'N/A'}</p>
                                            <p class="text-sm text-gray-600">${order.customer_email || 'N/A'}</p>
                                            <p class="text-sm text-gray-600">${order.customer_phone || 'N/A'}</p>
                                        </div>
                                        <div>
                                            <h4 class="font-medium text-gray-700">Order Items:</h4>
                                            ${items.length > 0 ? items.slice(0, 2).map(item => `
                                                <p class="text-sm text-gray-600">${item.quantity || 1}x ${item.name || 'Product'}</p>
                                            `).join('') : '<p class="text-sm text-gray-600">No items</p>'}
                                            ${items.length > 2 ? `<p class="text-sm text-gray-500">...and ${items.length - 2} more</p>` : ''}
                                        </div>
                                        <div>
                                            <h4 class="font-medium text-gray-700">Total:</h4>
                                            <p class="text-lg font-semibold text-purple-600">‚Ç¨${parseFloat(order.total || 0).toFixed(2)}</p>
                                            <p class="text-sm text-gray-500">${totalItems} items</p>
                                        </div>
                                    </div>
                                </div>
                                <div class="flex space-x-2 ml-4">
                                    <select onchange="updateOrderStatus('${order.id}', this.value); event.stopPropagation();" class="px-3 py-1 text-sm border border-gray-300 rounded">
                                        <option value="pending" ${order.status === 'pending' ? 'selected' : ''}>Pending</option>
                                        <option value="processing" ${order.status === 'processing' ? 'selected' : ''}>Processing</option>
                                        <option value="shipped" ${order.status === 'shipped' ? 'selected' : ''}>Shipped</option>
                                        <option value="delivered" ${order.status === 'delivered' ? 'selected' : ''}>Delivered</option>
                                        <option value="cancelled" ${order.status === 'cancelled' ? 'selected' : ''}>Cancelled</option>
                                    </select>
                                    <button onclick="viewOrderDetails('${order.id}'); event.stopPropagation();" class="px-3 py-1 text-sm bg-red-600 text-white rounded hover:bg-red-700">
                                        Details
                                    </button>
                                </div>
                            </div>
                            
                            <div class="flex items-center text-sm text-gray-500 space-x-4">
                                <span><i class="far fa-calendar mr-1"></i>${new Date(order.created_at).toLocaleDateString()}</span>
                                <span><i class="fas fa-credit-card mr-1"></i>${order.payment_method || 'N/A'}</span>
                            </div>
                        </div>
                    `;
                }).join('');

            } catch (error) {
                console.error('Error loading orders:', error);
                document.getElementById('orders-list').innerHTML = '<p class="text-red-500 text-center py-8">Error loading orders</p>';
            }
        }
        
        // Load users
        async function loadUsers() {
            try {
                const usersList = document.getElementById('users-list');
                let users = [];
                let error = null;
                
                // Try multiple approaches to get user data
                try {
                    console.log('üîç Loading users from profiles table...');
                    const { data: profileUsers, error: profileError } = await window.supabase
                        .from('profiles')
                        .select('*')
                        .order('created_at', { ascending: false });
                    
                    if (profileError) {
                        console.warn('‚ö†Ô∏è Profiles table error:', profileError);
                        throw profileError;
                    }
                    
                    users = profileUsers || [];
                    console.log(`‚úÖ Found ${users.length} users from profiles table`);
                    
                } catch (e) {
                    console.warn('‚ö†Ô∏è Cannot access profiles table, trying orders table...');
                    
                    // Fallback: Get user info from orders table
                    try {
                        const { data: orders, error: ordersError } = await window.supabase
                            .from('orders')
                            .select('user_id, customer_email, customer_name, customer_phone, customer_address, created_at')
                            .order('created_at', { ascending: false });
                        
                        if (ordersError) throw ordersError;
                        
                        // Create user objects from order data with better aggregation
                        const userMap = new Map();
                        orders?.forEach(order => {
                            if (order.user_id) {
                                const userId = order.user_id;
                                
                                if (!userMap.has(userId)) {
                                    // Create new user entry
                                    userMap.set(userId, {
                                        id: userId,
                                        email: order.customer_email || 'Unknown',
                                        full_name: order.customer_name || 'Unknown User',
                                        phone: order.customer_phone || null,
                                        address: order.customer_address || null,
                                        created_at: order.created_at,
                                        is_admin: false, // We can't determine this from orders
                                        source: 'orders',
                                        order_count: 1
                                    });
                                } else {
                                    // Update existing user with more complete info if available
                                    const existingUser = userMap.get(userId);
                                    
                                    // Use the most complete data available
                                    if (!existingUser.phone && order.customer_phone) {
                                        existingUser.phone = order.customer_phone;
                                    }
                                    if (!existingUser.address && order.customer_address) {
                                        existingUser.address = order.customer_address;
                                    }
                                    if (existingUser.full_name === 'Unknown User' && order.customer_name) {
                                        existingUser.full_name = order.customer_name;
                                    }
                                    if (existingUser.email === 'Unknown' && order.customer_email) {
                                        existingUser.email = order.customer_email;
                                    }
                                    
                                    // Use earliest order date as join date
                                    if (new Date(order.created_at) < new Date(existingUser.created_at)) {
                                        existingUser.created_at = order.created_at;
                                    }
                                    
                                    existingUser.order_count++;
                                }
                            }
                        });
                        
                        users = Array.from(userMap.values());
                        console.log(`‚úÖ Found ${users.length} users from orders table with aggregated data`);
                        
                    } catch (e2) {
                        console.error('‚ùå Both profiles and orders queries failed');
                        error = e2;
                    }
                }
                
                if (error && (!users || users.length === 0)) {
                    usersList.innerHTML = `
                        <div class="text-center py-8">
                            <p class="text-gray-500 mb-2">Cannot load users from database</p>
                            <p class="text-sm text-gray-400">Check database permissions for profiles table</p>
                            <p class="text-sm text-red-500 mt-2">Error: ${error.message}</p>
                        </div>
                    `;
                    return;
                }
                
                if (!users || users.length === 0) {
                    usersList.innerHTML = '<p class="text-gray-500 text-center py-8">No users found</p>';
                    return;
                }
                
                usersList.innerHTML = users.map(user => {
                    const isFromOrders = user.source === 'orders';
                    const userName = user.full_name || `${user.first_name || ''} ${user.last_name || ''}`.trim() || 'N/A';
                    
                    return `
                        <div class="bg-white border rounded-lg p-4 mb-4">
                            <div class="flex justify-between items-start">
                                <div class="flex-1">
                                    <div class="flex items-center space-x-4 mb-2">
                                        <h3 class="font-semibold text-gray-900">${user.email}</h3>
                                        <span class="px-2 py-1 text-xs rounded ${user.is_admin ? 'bg-red-100 text-red-800' : 'bg-green-100 text-green-800'}">
                                            ${user.is_admin ? 'Admin' : 'User'}
                                        </span>
                                        ${isFromOrders ? `
                                            <span class="px-2 py-1 text-xs bg-blue-100 text-blue-800 rounded">From Orders</span>
                                        ` : ''}
                                    </div>
                                    <div class="grid grid-cols-2 md:grid-cols-4 gap-4 text-sm text-gray-600">
                                        <div>
                                            <span class="text-gray-500">Name:</span><br>
                                            ${userName}
                                        </div>
                                        <div>
                                            <span class="text-gray-500">Phone:</span><br>
                                            ${user.phone || 'N/A'}
                                        </div>
                                        <div>
                                            <span class="text-gray-500">${isFromOrders ? 'Orders' : 'Company'}:</span><br>
                                            ${isFromOrders ? (user.order_count || 1) : (user.company || 'N/A')}
                                        </div>
                                        <div>
                                            <span class="text-gray-500">Joined:</span><br>
                                            ${new Date(user.created_at).toLocaleDateString()}
                                        </div>
                                    </div>
                                    ${user.address || user.city || user.country ? `
                                        <div class="mt-2 text-sm text-gray-600">
                                            <span class="text-gray-500">Address:</span>
                                            ${user.address || ''} ${user.city || ''} ${user.postal_code || ''} ${user.country || ''}
                                        </div>
                                    ` : ''}
                                </div>
                                <div class="flex space-x-2">
                                    ${!isFromOrders ? `
                                        <button onclick="toggleUserAdmin('${user.id}', ${!user.is_admin})" 
                                                class="px-3 py-1 text-sm ${user.is_admin ? 'bg-red-600 hover:bg-red-700' : 'bg-red-600 hover:bg-red-700'} text-white rounded">
                                            ${user.is_admin ? 'Remove Admin' : 'Make Admin'}
                                        </button>
                                    ` : ''}
                                    <button onclick="viewUserDetails('${user.id}')" class="px-3 py-1 text-sm bg-gray-600 text-white rounded hover:bg-gray-700">
                                        Details
                                    </button>
                                </div>
                            </div>
                        </div>
                    `;
                }).join('');
                
            } catch (error) {
                console.error('Error loading users:', error);
            }
        }
        
        // Load analytics
        async function loadAnalytics() {
            try {
                const analyticsContent = document.getElementById('analytics-content');
                
                // Load various statistics
                const [
                    { count: totalOrders },
                    { count: totalUsers },
                    { count: totalProducts },
                    { data: recentOrders }
                ] = await Promise.all([
                    window.supabase.from('orders').select('*', { count: 'exact', head: true }),
                    window.supabase.from('profiles').select('*', { count: 'exact', head: true }),
                    window.supabase.from('products').select('*', { count: 'exact', head: true }),
                    window.supabase.from('orders').select('*').order('created_at', { ascending: false }).limit(10)
                ]);
                
                // Calculate revenue
                const { data: orders } = await window.supabase
                    .from('orders')
                    .select('total_amount, created_at')
                    .eq('status', 'delivered');
                
                const totalRevenue = orders?.reduce((sum, order) => sum + parseFloat(order.total_amount), 0) || 0;
                
                // Monthly revenue calculation
                const currentMonth = new Date().getMonth();
                const currentYear = new Date().getFullYear();
                const monthlyRevenue = orders?.filter(order => {
                    const orderDate = new Date(order.created_at);
                    return orderDate.getMonth() === currentMonth && orderDate.getFullYear() === currentYear;
                }).reduce((sum, order) => sum + parseFloat(order.total_amount), 0) || 0;
                
                analyticsContent.innerHTML = `
                    <!-- Key Metrics -->
                    <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6 mb-8">
                        <div class="bg-red-50 rounded-lg p-6">
                            <div class="flex items-center">
                                <div class="flex-shrink-0">
                                    <i class="fas fa-euro-sign text-red-600 text-2xl"></i>
                                </div>
                                <div class="ml-4">
                                    <p class="text-sm font-medium text-red-600">Total Revenue</p>
                                    <p class="text-2xl font-bold text-gray-900">‚Ç¨${totalRevenue.toFixed(2)}</p>
                                </div>
                            </div>
                        </div>
                        
                        <div class="bg-green-50 rounded-lg p-6">
                            <div class="flex items-center">
                                <div class="flex-shrink-0">
                                    <i class="fas fa-shopping-cart text-green-600 text-2xl"></i>
                                </div>
                                <div class="ml-4">
                                    <p class="text-sm font-medium text-green-600">Total Orders</p>
                                    <p class="text-2xl font-bold text-gray-900">${totalOrders || 0}</p>
                                </div>
                            </div>
                        </div>
                        
                        <div class="bg-purple-50 rounded-lg p-6">
                            <div class="flex items-center">
                                <div class="flex-shrink-0">
                                    <i class="fas fa-users text-purple-600 text-2xl"></i>
                                </div>
                                <div class="ml-4">
                                    <p class="text-sm font-medium text-purple-600">Total Users</p>
                                    <p class="text-2xl font-bold text-gray-900">${totalUsers || 0}</p>
                                </div>
                            </div>
                        </div>
                        
                        <div class="bg-orange-50 rounded-lg p-6">
                            <div class="flex items-center">
                                <div class="flex-shrink-0">
                                    <i class="fas fa-box text-orange-600 text-2xl"></i>
                                </div>
                                <div class="ml-4">
                                    <p class="text-sm font-medium text-orange-600">Total Products</p>
                                    <p class="text-2xl font-bold text-gray-900">${totalProducts || 0}</p>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Monthly Stats -->
                    <div class="bg-white rounded-lg shadow-sm p-6 mb-6">
                        <h3 class="text-lg font-semibold text-gray-900 mb-4">This Month</h3>
                        <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
                            <div class="text-center">
                                <p class="text-2xl font-bold text-red-600">‚Ç¨${monthlyRevenue.toFixed(2)}</p>
                                <p class="text-sm text-gray-600">Monthly Revenue</p>
                            </div>
                            <div class="text-center">
                                <p class="text-2xl font-bold text-green-600">${orders?.filter(o => {
                                    const date = new Date(o.created_at);
                                    return date.getMonth() === currentMonth && date.getFullYear() === currentYear;
                                }).length || 0}</p>
                                <p class="text-sm text-gray-600">Monthly Orders</p>
                            </div>
                            <div class="text-center">
                                <p class="text-2xl font-bold text-purple-600">${totalRevenue > 0 ? (monthlyRevenue / totalRevenue * 100).toFixed(1) : 0}%</p>
                                <p class="text-sm text-gray-600">Revenue Growth</p>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Recent Orders -->
                    <div class="bg-white rounded-lg shadow-sm p-6">
                        <h3 class="text-lg font-semibold text-gray-900 mb-4">Recent Orders</h3>
                        ${recentOrders && recentOrders.length > 0 ? `
                            <div class="space-y-3">
                                ${recentOrders.map(order => `
                                    <div class="flex justify-between items-center py-2 border-b border-gray-100">
                                        <div>
                                            <span class="font-medium">Order #${order.id}</span>
                                            <span class="text-gray-500 text-sm ml-2">${new Date(order.created_at).toLocaleDateString()}</span>
                                        </div>
                                        <div class="flex items-center space-x-3">
                                            <span class="text-sm text-gray-600">‚Ç¨${order.total_amount}</span>
                                            <span class="px-2 py-1 text-xs rounded ${getOrderStatusColor(order.status)}">
                                                ${order.status}
                                            </span>
                                        </div>
                                    </div>
                                `).join('')}
                            </div>
                        ` : '<p class="text-gray-500 text-center py-4">No orders yet</p>'}
                    </div>
                `;
                
            } catch (error) {
                console.error('Error loading analytics:', error);
            }
        }
        
        // Load categories for management
        async function loadCategoriesForManagement() {
            try {
                const { data: categories, error } = await window.supabase
                    .from('categories')
                    .select('*')
                    .order('sort_order');
                
                const content = document.getElementById('categories-management-content');
                
                if (error || !categories || categories.length === 0) {
                    content.innerHTML = '<p class="text-gray-500 text-center py-8">No categories found</p>';
                    return;
                }
                
                // Group by parent categories
                const mainCategories = categories.filter(cat => !cat.parent_id);
                const subCategories = categories.filter(cat => cat.parent_id);
                
                content.innerHTML = `
                    <div class="space-y-6">
                        ${mainCategories.map(mainCat => `
                            <div class="bg-white border rounded-lg p-4">
                                <div class="flex justify-between items-center mb-3">
                                    <div>
                                        <h3 class="font-semibold text-gray-900">${mainCat.name_en}</h3>
                                        <p class="text-sm text-gray-600">${mainCat.slug}</p>
                                    </div>
                                    <div class="flex space-x-2">
                                        <span class="px-2 py-1 text-xs rounded ${mainCat.is_active ? 'bg-green-100 text-green-800' : 'bg-red-100 text-red-800'}">
                                            ${mainCat.is_active ? 'Active' : 'Inactive'}
                                        </span>
                                        <button onclick="editCategory('${mainCat.id}')" class="px-3 py-1 text-sm bg-red-600 text-white rounded hover:bg-red-700">
                                            Edit
                                        </button>
                                    </div>
                                </div>
                                
                                <!-- Subcategories -->
                                ${subCategories.filter(sub => sub.parent_id === mainCat.id).length > 0 ? `
                                    <div class="ml-4 space-y-2">
                                        <p class="text-sm font-medium text-gray-700">Subcategories:</p>
                                        ${subCategories.filter(sub => sub.parent_id === mainCat.id).map(subCat => `
                                            <div class="flex justify-between items-center bg-gray-50 rounded p-2">
                                                <div>
                                                    <span class="text-sm text-gray-900">${subCat.name_en}</span>
                                                    <span class="text-xs text-gray-500 ml-2">${subCat.slug}</span>
                                                </div>
                                                <div class="flex items-center space-x-2">
                                                    <span class="px-2 py-1 text-xs rounded ${subCat.is_active ? 'bg-green-100 text-green-800' : 'bg-red-100 text-red-800'}">
                                                        ${subCat.is_active ? 'Active' : 'Inactive'}
                                                    </span>
                                                    <button onclick="editCategory('${subCat.id}')" class="px-2 py-1 text-xs bg-red-600 text-white rounded hover:bg-red-700">
                                                        Edit
                                                    </button>
                                                </div>
                                            </div>
                                        `).join('')}
                                    </div>
                                ` : ''}
                            </div>
                        `).join('')}
                    </div>
                `;
                
            } catch (error) {
                console.error('Error loading categories:', error);
            }
        }
        
        // Utility functions
        function getOrderStatusColor(status) {
            switch (status) {
                case 'pending': return 'bg-yellow-100 text-yellow-800';
                case 'processing': return 'bg-red-100 text-red-800';
                case 'shipped': return 'bg-purple-100 text-purple-800';
                case 'delivered': return 'bg-green-100 text-green-800';
                case 'cancelled': return 'bg-red-100 text-red-800';
                default: return 'bg-gray-100 text-gray-800';
            }
        }
        
        // Event handlers for admin actions
        window.editProduct = async function(productId) {
            try {
                // Load the product data using standardized query
                console.log('Loading product for editing:', productId);
                const { data: product, error } = await window.DB_QUERIES.getProduct(productId);
                
                if (error || !product) {
                    console.error('Error loading product:', error);
                    alert('Failed to load product data');
                    return;
                }
                
                // Populate the edit form with current data
                document.getElementById('edit-product-id').value = product.id;
                document.getElementById('edit-part-code').value = product.part_code || '';
                document.getElementById('edit-name-en').value = product.name_en || '';
                document.getElementById('edit-name-ro').value = product.name_ro || '';
                document.getElementById('edit-name-ru').value = product.name_ru || '';
                document.getElementById('edit-price').value = product.price || '';
                document.getElementById('edit-stock-quantity').value = product.stock_quantity || '';
                document.getElementById('edit-image-url').value = product.image_url || '';
                
                // Load categories for the select dropdown
                await loadCategoriesForProductForm();
                
                // Populate category selects with current product's category
                if (product.category_id) {
                    populateEditCategorySelects(product.category_id);
                }
                
                // Handle optional specifications
                const hasSpecs = product.sku || product.brand || product.weight || product.width || product.height || product.warranty_months;
                const enableSpecsCheckbox = document.getElementById('edit-enable-specs');
                const optionalSpecsDiv = document.getElementById('edit-optional-specs');
                
                if (hasSpecs) {
                    enableSpecsCheckbox.checked = true;
                    optionalSpecsDiv.classList.remove('hidden');
                    
                    document.getElementById('edit-sku').value = product.sku || '';
                    document.getElementById('edit-brand').value = product.brand || '';
                    document.getElementById('edit-weight').value = product.weight || '';
                    document.getElementById('edit-width').value = product.width || '';
                    document.getElementById('edit-height').value = product.height || '';
                    document.getElementById('edit-warranty-months').value = product.warranty_months || '';
                }
                
                // Handle descriptions
                document.getElementById('edit-description-en').value = product.description_en || '';
                document.getElementById('edit-description-ro').value = product.description_ro || '';
                document.getElementById('edit-description-ru').value = product.description_ru || '';
                
                // Show the modal
                showModal('edit-product-modal');
                
            } catch (error) {
                console.error('Error in editProduct:', error);
                alert('Failed to open edit form');
            }
        };
        
        // Helper function to load categories for edit form
        async function loadCategoriesForEditForm() {
            try {
                const { data: categories, error } = await window.supabase
                    .from('categories')
                    .select('id, name_en, slug')
                    .order('sort_order');
                
                const categorySelect = document.getElementById('edit-category-id');
                
                // Clear existing options (except the first placeholder)
                categorySelect.innerHTML = '<option value="">Select Category</option>';
                
                if (categories && categories.length > 0) {
                    categories.forEach(category => {
                        const option = document.createElement('option');
                        option.value = category.id;
                        option.textContent = category.name_en;
                        categorySelect.appendChild(option);
                    });
                }
            } catch (error) {
                console.error('Error loading categories for edit form:', error);
            }
        }
        
        window.deleteProduct = async function(productId) {
            if (!confirm('Are you sure you want to delete this product?')) return;
            
            try {
                const { error } = await window.supabase
                    .from('products')
                    .delete()
                    .eq('id', productId);
                
                if (error) throw error;
                alert('Product deleted successfully');
                loadProductsForManagement();
            } catch (error) {
                console.error('Error deleting product:', error);
                alert('Failed to delete product');
            }
        };
        
        window.togglePromoCode = async function(promoId, isActive) {
            try {
                const { error } = await window.supabase
                    .from('promocodes')
                    .update({ is_active: isActive })
                    .eq('id', promoId);
                
                if (error) throw error;
                loadPromoCodes();
            } catch (error) {
                console.error('Error toggling promo code:', error);
            }
        };
        
        window.deletePromoCode = async function(promoId) {
            if (!confirm('Are you sure you want to delete this promo code?')) return;
            
            try {
                const { error } = await window.supabase
                    .from('promocodes')
                    .delete()
                    .eq('id', promoId);
                
                if (error) throw error;
                loadPromoCodes();
            } catch (error) {
                console.error('Error deleting promo code:', error);
            }
        };
        
        window.refreshPromoCodes = function() {
            console.log('üîÑ Refreshing promo codes...');
            loadPromoCodes();
        };
        
        window.updateOrderStatus = async function(orderId, status) {
            try {
                const { error } = await window.supabase
                    .from('orders')
                    .update({ status })
                    .eq('id', orderId);
                
                if (error) throw error;
                // Refresh orders list is optional here since select already shows updated value
            } catch (error) {
                console.error('Error updating order status:', error);
            }
        };
        
        window.viewOrderDetails = async function(orderId) {
            try {
                console.log('üîç Fetching order details for ID:', orderId);
                
                // Check if Supabase is available
                if (!window.supabase) {
                    console.error('‚ùå Supabase client not available');
                    alert('Database connection error. Please refresh the page.');
                    return;
                }
                
                // Get order details from database
                const { data: order, error } = await window.supabase
                    .from('orders')
                    .select('*')
                    .eq('id', orderId)
                    .single();
                
                if (error) {
                    console.error('‚ùå Error fetching order details:', error);
                    console.error('Error code:', error.code);
                    console.error('Error message:', error.message);
                    
                    // Provide more specific error messages
                    if (error.code === 'PGRST116') {
                        alert('Comanda nu a fost gƒÉsitƒÉ √Æn baza de date.');
                    } else if (error.message.includes('permission')) {
                        alert('Nu ave»õi permisiuni sƒÉ accesa»õi aceastƒÉ comandƒÉ.');
                    } else {
                        alert(`Eroare la √ÆncƒÉrcarea detaliilor comenzii: ${error.message}`);
                    }
                    return;
                }
                
                if (!order) {
                    console.error('‚ùå No order data returned');
                    alert('Comanda nu a fost gƒÉsitƒÉ.');
                    return;
                }
                
                console.log('‚úÖ Order details loaded successfully:', order);
                
                const items = order.items || [];
                
                // Create modal for order details
                const modal = document.createElement('div');
                modal.className = 'fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4';
                modal.innerHTML = `
                    <div class="bg-white rounded-lg max-w-4xl w-full max-h-[90vh] overflow-y-auto">
                        <div class="p-6">
                            <div class="flex justify-between items-center mb-4">
                                <h2 class="text-2xl font-bold text-gray-800">Detalii ComandƒÉ #${order.id.slice(-8)}</h2>
                                <button onclick="this.closest('.fixed').remove()" class="text-gray-500 hover:text-gray-700">
                                    <i class="fas fa-times text-xl"></i>
                                </button>
                            </div>
                            
                            <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-6">
                                <div>
                                    <h3 class="text-lg font-semibold mb-3">Informa»õii ComandƒÉ</h3>
                                    <div class="space-y-2">
                                        <p><span class="font-medium">Status:</span> <span class="px-2 py-1 rounded text-sm bg-red-100 text-red-800">${order.status || 'pending'}</span></p>
                                        <p><span class="font-medium">Data:</span> ${new Date(order.created_at).toLocaleString('ro-RO')}</p>
                                        <p><span class="font-medium">Total:</span> ‚Ç¨${parseFloat(order.total || 0).toFixed(2)}</p>
                                        <p><span class="font-medium">Subtotal:</span> ‚Ç¨${parseFloat(order.subtotal || 0).toFixed(2)}</p>
                                        <p><span class="font-medium">Reducere:</span> ‚Ç¨${parseFloat(order.discount_amount || 0).toFixed(2)}</p>
                                        <p><span class="font-medium">Livrare:</span> ‚Ç¨${parseFloat(order.shipping_cost || 0).toFixed(2)}</p>
                                        <p><span class="font-medium">MetodƒÉ platƒÉ:</span> ${order.payment_method || 'N/A'}</p>
                                    </div>
                                </div>
                                
                                <div>
                                    <h3 class="text-lg font-semibold mb-3">Date Client</h3>
                                    <div class="space-y-2">
                                        <p><span class="font-medium">Nume:</span> ${order.customer_name || 'N/A'}</p>
                                        <p><span class="font-medium">Email:</span> ${order.customer_email || 'N/A'}</p>
                                        <p><span class="font-medium">Telefon:</span> ${order.customer_phone || 'N/A'}</p>
                                        <p><span class="font-medium">AdresƒÉ:</span> ${order.customer_address || 'N/A'}</p>
                                        ${order.notes ? `<p><span class="font-medium">Noti»õe:</span> ${order.notes}</p>` : ''}
                                    </div>
                                </div>
                            </div>
                            
                            <div>
                                <h3 class="text-lg font-semibold mb-3">Produse Comandate</h3>
                                <div class="overflow-x-auto">
                                    <table class="min-w-full divide-y divide-gray-200">
                                        <thead class="bg-gray-50">
                                            <tr>
                                                <th class="px-4 py-2 text-left text-xs font-medium text-gray-500 uppercase">Produs</th>
                                                <th class="px-4 py-2 text-left text-xs font-medium text-gray-500 uppercase">Cantitate</th>
                                                <th class="px-4 py-2 text-left text-xs font-medium text-gray-500 uppercase">Pre»õ Unitar</th>
                                                <th class="px-4 py-2 text-left text-xs font-medium text-gray-500 uppercase">Total</th>
                                            </tr>
                                        </thead>
                                        <tbody class="bg-white divide-y divide-gray-200">
                                            ${items.length > 0 ? items.map(item => `
                                                <tr>
                                                    <td class="px-4 py-2">
                                                        <span class="font-medium">${item.name || 'Produs necunoscut'}</span>
                                                    </td>
                                                    <td class="px-4 py-2">${item.quantity || 1}</td>
                                                    <td class="px-4 py-2">‚Ç¨${parseFloat(item.price || 0).toFixed(2)}</td>
                                                    <td class="px-4 py-2 font-medium">‚Ç¨${parseFloat(item.total || (item.price * item.quantity) || 0).toFixed(2)}</td>
                                                </tr>
                                            `).join('') : '<tr><td colspan="4" class="px-4 py-2 text-center">Nu existƒÉ produse</td></tr>'}
                                        </tbody>
                                    </table>
                                </div>
                            </div>
                            
                            <div class="mt-6 flex justify-end space-x-3">
                                <button onclick="this.closest('.fixed').remove()" class="px-4 py-2 bg-gray-600 text-white rounded hover:bg-gray-700">
                                    √énchide
                                </button>
                            </div>
                        </div>
                    </div>
                `;
                
                document.body.appendChild(modal);
                
            } catch (error) {
                console.error('Error viewing order details:', error);
                alert('Eroare la afi»ôarea detaliilor comenzii');
            }
        };
        
        window.toggleUserAdmin = async function(userId, makeAdmin) {
            try {
                console.log(`üîÑ Attempting to ${makeAdmin ? 'grant' : 'revoke'} admin access for user:`, userId);
                
                // Show loading state
                const button = event.target;
                const originalText = button.textContent;
                button.disabled = true;
                button.textContent = 'Updating...';
                
                // Update user admin status
                const { data, error } = await window.supabase
                    .from('profiles')
                    .update({ is_admin: makeAdmin })
                    .eq('id', userId)
                    .select();
                
                if (error) {
                    console.error('‚ùå Supabase error details:', {
                        message: error.message,
                        details: error.details,
                        hint: error.hint,
                        code: error.code
                    });
                    
                    // Provide user-friendly error messages
                    let userMessage = error.message;
                    if (error.code === '42501' || error.message.includes('permission')) {
                        userMessage = 'Permission denied. You may not have admin privileges to change user roles.';
                    } else if (error.code === '23503') {
                        userMessage = 'User not found in the system.';
                    }
                    
                    throw new Error(userMessage);
                }
                
                console.log('‚úÖ Admin status updated successfully:', data);
                
                // Show success message
                const action = makeAdmin ? 'granted admin access to' : 'revoked admin access from';
                alert(`Successfully ${action} user.`);
                
                // Reload users list to reflect changes
                await loadUsers();
                
            } catch (error) {
                console.error('‚ùå Error updating user admin status:', error);
                alert('Failed to update user admin status: ' + error.message);
                
                // Reload users to ensure UI is in sync with database
                await loadUsers();
            }
        };
        
        window.viewUserDetails = async function(userId) {
            try {
                // Get user details from database
                const { data: user, error } = await supabase
                    .from('profiles')
                    .select(`
                        *,
                        orders (
                            id,
                            order_number,
                            total_amount,
                            status,
                            created_at
                        )
                    `)
                    .eq('id', userId)
                    .single();
                
                if (error) {
                    console.error('Error fetching user details:', error);
                    alert('Eroare la √ÆncƒÉrcarea detaliilor utilizatorului');
                    return;
                }
                
                // Create modal for user details
                const modal = document.createElement('div');
                modal.className = 'fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4';
                modal.innerHTML = `
                    <div class="bg-white rounded-lg max-w-4xl w-full max-h-[90vh] overflow-y-auto">
                        <div class="p-6">
                            <div class="flex justify-between items-center mb-4">
                                <h2 class="text-2xl font-bold text-gray-800">Detalii Utilizator</h2>
                                <button onclick="this.closest('.fixed').remove()" class="text-gray-500 hover:text-gray-700">
                                    <i class="fas fa-times text-xl"></i>
                                </button>
                            </div>
                            
                            <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-6">
                                <div>
                                    <h3 class="text-lg font-semibold mb-3">Informa»õii Personale</h3>
                                    <div class="space-y-3">
                                        <p><span class="font-medium">Nume complet:</span> ${user.full_name || 'N/A'}</p>
                                        <p><span class="font-medium">Email:</span> ${user.email}</p>
                                        <p><span class="font-medium">Telefon:</span> ${user.phone || 'N/A'}</p>
                                        <p><span class="font-medium">Admin:</span> 
                                            <span class="px-2 py-1 rounded text-sm ${user.is_admin ? 'bg-green-100 text-green-800' : 'bg-gray-100 text-gray-800'}">
                                                ${user.is_admin ? 'Da' : 'Nu'}
                                            </span>
                                        </p>
                                        <p><span class="font-medium">Data √ÆnregistrƒÉrii:</span> ${new Date(user.created_at).toLocaleString('ro-RO')}</p>
                                        <p><span class="font-medium">Ultima actualizare:</span> ${user.updated_at ? new Date(user.updated_at).toLocaleString('ro-RO') : 'N/A'}</p>
                                    </div>
                                </div>
                                
                                <div>
                                    <h3 class="text-lg font-semibold mb-3">Statistici Comenzi</h3>
                                    <div class="space-y-3">
                                        <p><span class="font-medium">Total comenzi:</span> ${user.orders?.length || 0}</p>
                                        <p><span class="font-medium">Valoare totalƒÉ:</span> ‚Ç¨${user.orders?.reduce((sum, order) => sum + parseFloat(order.total_amount || 0), 0).toFixed(2) || '0.00'}</p>
                                        <p><span class="font-medium">Ultima comandƒÉ:</span> 
                                            ${user.orders?.length > 0 ? new Date(Math.max(...user.orders.map(o => new Date(o.created_at)))).toLocaleDateString('ro-RO') : 'NiciodatƒÉ'}
                                        </p>
                                    </div>
                                </div>
                            </div>
                            
                            ${user.orders?.length > 0 ? `
                            <div>
                                <h3 class="text-lg font-semibold mb-3">Istoric Comenzi</h3>
                                <div class="overflow-x-auto">
                                    <table class="min-w-full divide-y divide-gray-200">
                                        <thead class="bg-gray-50">
                                            <tr>
                                                <th class="px-4 py-2 text-left text-xs font-medium text-gray-500 uppercase">Nr. ComandƒÉ</th>
                                                <th class="px-4 py-2 text-left text-xs font-medium text-gray-500 uppercase">Data</th>
                                                <th class="px-4 py-2 text-left text-xs font-medium text-gray-500 uppercase">Status</th>
                                                <th class="px-4 py-2 text-left text-xs font-medium text-gray-500 uppercase">Total</th>
                                                <th class="px-4 py-2 text-left text-xs font-medium text-gray-500 uppercase">Ac»õiuni</th>
                                            </tr>
                                        </thead>
                                        <tbody class="bg-white divide-y divide-gray-200">
                                            ${user.orders.map(order => `
                                                <tr>
                                                    <td class="px-4 py-2 font-medium">#${order.order_number}</td>
                                                    <td class="px-4 py-2">${new Date(order.created_at).toLocaleDateString('ro-RO')}</td>
                                                    <td class="px-4 py-2">
                                                        <span class="px-2 py-1 rounded text-sm bg-red-100 text-red-800">${order.status}</span>
                                                    </td>
                                                    <td class="px-4 py-2">‚Ç¨${order.total_amount}</td>
                                                    <td class="px-4 py-2">
                                                        <button onclick="this.closest('.fixed').remove(); viewOrderDetails('${order.id}')" class="text-red-600 hover:text-red-800">
                                                            <i class="fas fa-eye"></i>
                                                        </button>
                                                    </td>
                                                </tr>
                                            `).join('')}
                                        </tbody>
                                    </table>
                                </div>
                            </div>
                            ` : '<p class="text-gray-500 text-center py-4">Acest utilizator nu are comenzi √ÆncƒÉ.</p>'}
                            
                            <div class="mt-6 flex justify-end space-x-3">
                                <button onclick="this.closest('.fixed').remove()" class="px-4 py-2 bg-gray-600 text-white rounded hover:bg-gray-700">
                                    √énchide
                                </button>
                                ${!user.is_admin ? `
                                <button onclick="this.closest('.fixed').remove(); toggleUserAdmin('${userId}', true)" class="px-4 py-2 bg-green-600 text-white rounded hover:bg-green-700">
                                    FƒÉ Admin
                                </button>
                                ` : `
                                <button onclick="this.closest('.fixed').remove(); toggleUserAdmin('${userId}', false)" class="px-4 py-2 bg-red-600 text-white rounded hover:bg-red-700">
                                    EliminƒÉ Admin
                                </button>
                                `}
                            </div>
                        </div>
                    </div>
                `;
                
                document.body.appendChild(modal);
                
            } catch (error) {
                console.error('Error viewing user details:', error);
                alert('Eroare la afi»ôarea detaliilor utilizatorului');
            }
        };
        
        window.editCategory = async function(categoryId) {
            try {
                console.log('üìù Opening edit category modal for:', categoryId);
                
                // Load category data
                const { data: category, error } = await window.supabase
                    .from('categories')
                    .select('*')
                    .eq('id', categoryId)
                    .single();
                
                if (error) throw error;
                
                if (!category) {
                    alert('Category not found');
                    return;
                }
                
                console.log('‚úÖ Category data loaded:', category);
                
                // Populate form fields
                document.getElementById('edit-category-id').value = category.id;
                document.getElementById('edit-category-name-en').value = category.name_en || '';
                document.getElementById('edit-category-name-ro').value = category.name_ro || '';
                document.getElementById('edit-category-name-ru').value = category.name_ru || '';
                document.getElementById('edit-category-slug').value = category.slug || '';
                document.getElementById('edit-category-description').value = category.description || '';
                document.getElementById('edit-category-sort-order').value = category.sort_order || 0;
                document.getElementById('edit-category-active').checked = category.is_active || false;
                
                // Set category type
                const isSubcategory = !!category.parent_id;
                const categoryTypeRadios = document.querySelectorAll('input[name="category_type"]');
                categoryTypeRadios.forEach(radio => {
                    radio.checked = radio.value === (isSubcategory ? 'sub' : 'main');
                });
                
                // Handle parent category section
                const parentSection = document.getElementById('parent-category-section');
                if (isSubcategory) {
                    parentSection.classList.remove('hidden');
                    await loadParentCategoriesForEdit();
                    document.getElementById('edit-parent-category').value = category.parent_id;
                } else {
                    parentSection.classList.add('hidden');
                }
                
                // Show modal
                showModal('edit-category-modal');
                
            } catch (error) {
                console.error('‚ùå Error loading category for edit:', error);
                alert('Failed to load category data: ' + error.message);
            }
        };
        
        // Load parent categories for edit form
        async function loadParentCategoriesForEdit() {
            try {
                const { data: parentCategories, error } = await window.supabase
                    .from('categories')
                    .select('id, name_en, name_ro, name_ru')
                    .is('parent_id', null)
                    .eq('is_active', true)
                    .order('sort_order', { ascending: true })
                    .order('name_en', { ascending: true });
                
                if (error) throw error;
                
                const select = document.getElementById('edit-parent-category');
                select.innerHTML = '<option value="">Select Parent Category</option>';
                
                parentCategories?.forEach(cat => {
                    const option = document.createElement('option');
                    option.value = cat.id;
                    option.textContent = cat.name_en || cat.name_ro || cat.name_ru || 'Unnamed Category';
                    select.appendChild(option);
                });
                
            } catch (error) {
                console.error('Error loading parent categories:', error);
            }
        }
        
        // Generate unique part code
        window.generatePartCode = async function() {
            try {
                // Generate a part code with format VH-XXX-YYY-ZZZ
                const timestamp = Date.now().toString(36).toUpperCase();
                const random = Math.random().toString(36).substring(2, 5).toUpperCase();
                const partCode = `VH-${timestamp}-${random}`;
                
                // Check if it already exists (very unlikely but just in case)
                const { data: existing } = await window.supabase
                    .from('products')
                    .select('id')
                    .eq('part_code', partCode)
                    .single();
                
                if (existing) {
                    // Generate another one if somehow it exists
                    const fallbackCode = `VH-${Date.now().toString(36).toUpperCase()}-${Math.random().toString(36).substring(2, 8).toUpperCase()}`;
                    document.querySelector('input[name="part_code"]').value = fallbackCode;
                } else {
                    document.querySelector('input[name="part_code"]').value = partCode;
                }
                
            } catch (error) {
                console.error('Error generating part code:', error);
                // Fallback to simple generation
                const fallbackCode = `VH-${Date.now().toString(36).toUpperCase()}`;
                document.querySelector('input[name="part_code"]').value = fallbackCode;
            }
        };
        
        // Form submissions
        document.addEventListener('DOMContentLoaded', function() {
            // Add product form
            const addProductForm = document.getElementById('add-product-form');
            if (addProductForm) {
                addProductForm.addEventListener('submit', async function(e) {
                    e.preventDefault();
                    
                    // Validate subcategory selection
                    const subcategorySelect = document.getElementById('subcategory-select');
                    if (!subcategorySelect.value) {
                        alert('Please select both a main category and subcategory');
                        return;
                    }
                    
                    const formData = new FormData(e.target);
                    const productData = Object.fromEntries(formData);
                    
                    // Convert string values to appropriate types
                    productData.price = parseFloat(productData.price);
                    productData.stock_quantity = parseInt(productData.stock_quantity);
                    productData.is_active = true;
                    productData.status = 'active';
                    productData.created_at = new Date().toISOString();
                    
                    // Generate slug if not provided (backup for database trigger)
                    if (!productData.slug) {
                        const nameForSlug = productData.name_en || productData.part_code || 'product';
                        const baseSlug = nameForSlug.toLowerCase()
                            .replace(/[^a-z0-9]+/g, '-')
                            .replace(/^-+|-+$/g, '');
                        
                        // Add timestamp to make it more unique
                        const timestamp = Date.now().toString(36);
                        productData.slug = `${baseSlug}-${timestamp}`;
                    }
                    
                    if (productData.weight) productData.weight = parseFloat(productData.weight);
                    if (productData.width) productData.width = parseFloat(productData.width);
                    if (productData.height) productData.height = parseFloat(productData.height);
                    
                    // Remove empty fields
                    Object.keys(productData).forEach(key => {
                        if (productData[key] === '' || productData[key] === null) {
                            delete productData[key];
                        }
                    });
                    
                    try {
                        // Show loading state
                        const submitButton = document.getElementById('add-product-submit');
                        const submitText = submitButton.querySelector('.add-product-text');
                        const submitLoading = submitButton.querySelector('.add-product-loading');
                        
                        submitButton.disabled = true;
                        submitText.classList.add('hidden');
                        submitLoading.classList.remove('hidden');
                        
                        console.log('üöÄ Attempting to add product:', productData);
                        
                        // Validate required fields
                        const requiredFields = ['part_code', 'name_en', 'category_id', 'price', 'stock_quantity'];
                        for (const field of requiredFields) {
                            if (!productData[field]) {
                                throw new Error(`Missing required field: ${field}`);
                            }
                        }
                        
                        // Wait for CONFIG to be available
                        let supabaseClient = window.supabase || window.CONFIG?.supabase;
                        let attempts = 0;
                        while (!supabaseClient && attempts < 30) {
                            await new Promise(resolve => setTimeout(resolve, 100));
                            supabaseClient = window.supabase || window.CONFIG?.supabase;
                            attempts++;
                        }
                        
                        if (!supabaseClient) {
                            throw new Error('Database connection not available. Please refresh the page and try again.');
                        }
                        
                        console.log('‚úÖ Supabase client available, checking part code uniqueness...');
                        
                        // Check if part code already exists
                        console.log('üîç Checking if part code already exists...');
                        const { data: existingProduct, error: checkError } = await supabaseClient
                            .from('products')
                            .select('id, part_code')
                            .eq('part_code', productData.part_code)
                            .single();
                            
                        if (checkError && checkError.code !== 'PGRST116') {
                            // PGRST116 is "not found" which is what we want
                            console.warn('‚ö†Ô∏è Error checking part code:', checkError);
                        } else if (existingProduct) {
                            throw new Error(`A product with part code "${productData.part_code}" already exists. Please use a different part code.`);
                        }
                        
                        console.log('‚úÖ Part code is unique, proceeding with product creation...');
                        
                        const { data, error } = await supabaseClient
                            .from('products')
                            .insert([productData])
                            .select();
                        
                        if (error) {
                            console.error('‚ùå Supabase error details:', {
                                message: error.message,
                                details: error.details,
                                hint: error.hint,
                                code: error.code
                            });
                            
                            // Provide user-friendly error messages
                            let userMessage = error.message;
                            if (error.code === '23505') {
                                // Unique constraint violation - check which field
                                if (error.details && error.details.includes('part_code')) {
                                    userMessage = 'A product with this part code already exists';
                                } else if (error.details && error.details.includes('slug')) {
                                    userMessage = 'A product with this name/slug already exists. Please use a different name.';
                                } else if (error.details && error.details.includes('sku')) {
                                    userMessage = 'A product with this SKU already exists';
                                } else {
                                    // Generic unique constraint message if we can't determine the field
                                    console.log('üîç Unique constraint details:', error.details);
                                    userMessage = 'A product with these details already exists. Please check part code, name, and SKU.';
                                }
                            } else if (error.code === '23503') {
                                userMessage = 'Invalid category selected';
                            } else if (error.message.includes('permission')) {
                                userMessage = 'Permission denied. Please check your admin privileges';
                            }
                            
                            throw new Error(userMessage);
                        }
                        
                        if (!data || data.length === 0) {
                            throw new Error('Product was not created (no data returned)');
                        }
                        
                        console.log('‚úÖ Product added successfully:', data[0]);
                        alert(`Product "${data[0].name_en}" added successfully!`);
                        closeModal('add-product-modal');
                        e.target.reset();
                        
                        // Reset subcategory dropdown
                        const subcategorySelect = document.getElementById('subcategory-select');
                        if (subcategorySelect) {
                            subcategorySelect.disabled = true;
                            subcategorySelect.innerHTML = '<option value="">First select main category</option>';
                        }
                        
                        loadProductsForManagement();
                    } catch (error) {
                        console.error('‚ùå Error adding product:', error);
                        alert(`Failed to add product: ${error.message}`);
                    } finally {
                        // Reset loading state
                        const submitButton = document.getElementById('add-product-submit');
                        const submitText = submitButton.querySelector('.add-product-text');
                        const submitLoading = submitButton.querySelector('.add-product-loading');
                        
                        if (submitButton && submitText && submitLoading) {
                            submitButton.disabled = false;
                            submitText.classList.remove('hidden');
                            submitLoading.classList.add('hidden');
                        }
                    }
                });
            }
            
            // Edit product form
            const editProductForm = document.getElementById('edit-product-form');
            if (editProductForm) {
                editProductForm.addEventListener('submit', async function(e) {
                    e.preventDefault();
                    
                    // Validate subcategory selection
                    const editSubcategorySelect = document.getElementById('edit-subcategory');
                    if (!editSubcategorySelect.value) {
                        alert('Please select both a main category and subcategory');
                        return;
                    }
                    
                    const formData = new FormData(e.target);
                    const productData = Object.fromEntries(formData);
                    
                    // Get the product ID
                    const productId = productData.product_id;
                    delete productData.product_id;
                    
                    // Convert string values to appropriate types
                    productData.price = parseFloat(productData.price);
                    productData.stock_quantity = parseInt(productData.stock_quantity);
                    productData.updated_at = new Date().toISOString();
                    
                    // Generate slug if not provided (backup for database trigger)
                    if (!productData.slug) {
                        const nameForSlug = productData.name_en || productData.part_code || 'product';
                        const baseSlug = nameForSlug.toLowerCase()
                            .replace(/[^a-z0-9]+/g, '-')
                            .replace(/^-+|-+$/g, '');
                        
                        // Add timestamp to make it more unique
                        const timestamp = Date.now().toString(36);
                        productData.slug = `${baseSlug}-${timestamp}`;
                    }
                    
                    if (productData.weight) productData.weight = parseFloat(productData.weight);
                    if (productData.width) productData.width = parseFloat(productData.width);
                    if (productData.height) productData.height = parseFloat(productData.height);
                    
                    // Remove empty fields
                    Object.keys(productData).forEach(key => {
                        if (productData[key] === '' || productData[key] === null) {
                            delete productData[key];
                        }
                    });
                    
                    try {
                        console.log('Attempting to update product:', productId, productData);
                        
                        const { data, error } = await window.supabase
                            .from('products')
                            .update(productData)
                            .eq('id', productId)
                            .select();
                        
                        if (error) {
                            console.error('Supabase error:', error);
                            throw error;
                        }
                        
                        console.log('Product updated successfully:', data);
                        alert('Product updated successfully!');
                        closeModal('edit-product-modal');
                        loadProductsForManagement();
                    } catch (error) {
                        console.error('Error updating product:', error);
                        alert(`Failed to update product: ${error.message}`);
                    }
                });
            }
            
            // Edit category form
            const editCategoryForm = document.getElementById('edit-category-form');
            if (editCategoryForm) {
                editCategoryForm.addEventListener('submit', async function(e) {
                    e.preventDefault();
                    
                    const formData = new FormData(e.target);
                    const categoryData = Object.fromEntries(formData);
                    const categoryId = categoryData.category_id;
                    delete categoryData.category_id;
                    
                    // Handle checkbox values
                    categoryData.is_active = formData.get('is_active') === 'on';
                    
                    // Convert sort order to number
                    if (categoryData.sort_order) {
                        categoryData.sort_order = parseInt(categoryData.sort_order);
                    }
                    
                    // Handle parent_id for subcategories
                    if (categoryData.category_type === 'main') {
                        categoryData.parent_id = null;
                    }
                    delete categoryData.category_type; // Remove this field as it's not stored
                    
                    // Remove empty fields
                    Object.keys(categoryData).forEach(key => {
                        if (categoryData[key] === '' || categoryData[key] === null || categoryData[key] === undefined) {
                            if (key !== 'parent_id') { // Keep parent_id even if null
                                delete categoryData[key];
                            }
                        }
                    });
                    
                    const submitButton = e.target.querySelector('button[type="submit"]');
                    const submitText = submitButton.querySelector('.update-category-text');
                    const submitLoading = submitButton.querySelector('.update-category-loading');
                    
                    try {
                        // Show loading state
                        submitButton.disabled = true;
                        submitText.classList.add('hidden');
                        submitLoading.classList.remove('hidden');
                        
                        console.log('üîÑ Updating category:', categoryId, categoryData);
                        
                        // Validate required fields
                        if (!categoryData.name_en || !categoryData.slug) {
                            throw new Error('Name (English) and Slug are required');
                        }
                        
                        // Update category in database
                        const { data, error } = await window.supabase
                            .from('categories')
                            .update(categoryData)
                            .eq('id', categoryId)
                            .select();
                        
                        if (error) {
                            console.error('‚ùå Supabase error:', error);
                            
                            // Provide user-friendly error messages
                            let userMessage = error.message;
                            if (error.code === '23505') {
                                if (error.details && error.details.includes('slug')) {
                                    userMessage = 'A category with this slug already exists. Please use a different slug.';
                                } else {
                                    userMessage = 'A category with these details already exists.';
                                }
                            } else if (error.code === '23503') {
                                userMessage = 'Invalid parent category selected.';
                            }
                            
                            throw new Error(userMessage);
                        }
                        
                        if (!data || data.length === 0) {
                            throw new Error('No data returned from update operation');
                        }
                        
                        console.log('‚úÖ Category updated successfully:', data);
                        alert('Category updated successfully!');
                        
                        // Close modal and reload categories
                        closeModal('edit-category-modal');
                        loadCategoriesManagement(); // Refresh categories list
                        
                    } catch (error) {
                        console.error('‚ùå Error updating category:', error);
                        alert('Failed to update category: ' + error.message);
                    } finally {
                        // Reset loading state
                        submitButton.disabled = false;
                        submitText.classList.remove('hidden');
                        submitLoading.classList.add('hidden');
                    }
                });
            }
            
            // Create promo form
            const createPromoForm = document.getElementById('create-promo-form');
            if (createPromoForm) {
                createPromoForm.addEventListener('submit', async function(e) {
                    e.preventDefault();
                    const formData = new FormData(e.target);
                    const promoData = Object.fromEntries(formData);
                    
                    // Prepare promo data with all required fields
                    const promoInsert = {
                        code: promoData.code.toUpperCase(),
                        discount_percent: parseInt(promoData.discount_percent),
                        max_uses: parseInt(promoData.max_uses),
                        current_uses: 0,
                        is_active: true,
                        created_at: new Date().toISOString(),
                        updated_at: new Date().toISOString()
                    };
                    
                    // Check if promo_codes table has discount_type column
                    try {
                        // Try to check table structure first
                        const { data: testData, error: testError } = await window.supabase
                            .from('promocodes')
                            .select('*')
                            .limit(1);
                        
                        // If the table exists and has discount_type, add those fields
                        if (testData !== null) {
                            promoInsert.discount_type = 'percentage';
                            promoInsert.discount_value = parseFloat(promoData.discount_percent);
                        }
                    } catch (e) {
                        console.log('Checking promo_codes structure:', e);
                    }
                    
                    try {
                        console.log('Creating promo code:', promoInsert);
                        
                        const { data, error } = await window.supabase
                            .from('promocodes')
                            .insert([promoInsert])
                            .select();
                        
                        if (error) {
                            console.error('Promo creation error:', error);
                            throw error;
                        }
                        
                        console.log('Promo code created:', data);
                        alert('Promo code created successfully!');
                        e.target.reset();
                        loadPromoCodes();
                    } catch (error) {
                        console.error('Error creating promo code:', error);
                        alert(`Failed to create promo code: ${error.message}`);
                    }
                });
            }
            
            // Toggle additional details in add product form
            const includeDetailsCheckbox = document.getElementById('include-details');
            const additionalDetails = document.getElementById('additional-details');
            if (includeDetailsCheckbox && additionalDetails) {
                includeDetailsCheckbox.addEventListener('change', function() {
                    if (this.checked) {
                        additionalDetails.classList.remove('hidden');
                    } else {
                        additionalDetails.classList.add('hidden');
                    }
                });
            }
            
            // Edit product modal checkbox for specifications
            const editEnableSpecsCheckbox = document.getElementById('edit-enable-specs');
            const editOptionalSpecs = document.getElementById('edit-optional-specs');
            if (editEnableSpecsCheckbox && editOptionalSpecs) {
                editEnableSpecsCheckbox.addEventListener('change', function() {
                    if (this.checked) {
                        editOptionalSpecs.classList.remove('hidden');
                    } else {
                        editOptionalSpecs.classList.add('hidden');
                    }
                });
            }
        });
        
        // Load categories for product form
        async function loadCategoriesForProductForm() {
            try {
                console.log('üìÇ Loading categories for product form...');
                
                if (!window.supabase) {
                    throw new Error('Supabase not initialized');
                }
                
                const { data: allCategories, error } = await window.supabase
                    .from('categories')
                    .select('*')
                    .order('sort_order');
                
                if (error) {
                    console.error('‚ùå Supabase error loading categories:', error);
                    throw error;
                }
                
                if (!allCategories || allCategories.length === 0) {
                    console.warn('‚ö†Ô∏è No categories found in database');
                    throw new Error('No categories found. Please create categories first.');
                }
                
                console.log(`üìã Found ${allCategories.length} categories:`, allCategories);
                
                const parentCategorySelect = document.getElementById('parent-category-select');
                const categoryFilter = document.getElementById('product-category-filter');
                
                // Separate parent categories and subcategories
                const parentCategories = allCategories.filter(cat => !cat.parent_id);
                const subcategories = allCategories.filter(cat => cat.parent_id);
                
                console.log(`üëî Parent categories: ${parentCategories.length}`, parentCategories);
                console.log(`üîñ Subcategories: ${subcategories.length}`, subcategories);
                
                // Load parent categories
                if (parentCategorySelect) {
                    parentCategorySelect.innerHTML = '<option value="">Select Main Category</option>';
                    parentCategories.forEach(cat => {
                        const option = document.createElement('option');
                        option.value = cat.id;
                        option.textContent = cat.name_en || cat.name || 'Unknown Category';
                        parentCategorySelect.appendChild(option);
                    });
                    console.log('‚úÖ Parent categories loaded into dropdown');
                }
                
                // Store all categories for subcategory loading
                window.allCategoriesData = allCategories;
                
                if (categoryFilter) {
                    categoryFilter.innerHTML = '<option value="">All Categories</option>';
                    allCategories.forEach(cat => {
                        const option = document.createElement('option');
                        option.value = cat.id;
                        option.textContent = cat.name_en || cat.name || 'Unknown Category';
                        categoryFilter.appendChild(option);
                    });
                    console.log('‚úÖ Category filter loaded');
                }
                
            } catch (error) {
                console.error('‚ùå Error loading categories:', error);
                throw error;
            }
        }
        
        // Load subcategories when parent category is selected
        function loadSubcategories(parentCategoryId) {
            console.log('üîñ Loading subcategories for parent:', parentCategoryId);
            const subcategorySelect = document.getElementById('subcategory-select');
            
            if (!parentCategoryId) {
                subcategorySelect.disabled = true;
                subcategorySelect.innerHTML = '<option value="">First select main category</option>';
                console.log('üîÑ No parent category selected, disabling subcategory dropdown');
                return;
            }
            
            if (!window.allCategoriesData) {
                console.error('‚ùå Categories data not loaded');
                alert('Categories data not loaded. Please refresh the page and try again.');
                return;
            }
            
            // Filter subcategories for the selected parent
            const subcategories = window.allCategoriesData.filter(cat => 
                cat.parent_id && cat.parent_id.toString() === parentCategoryId.toString()
            );
            
            console.log(`üéØ Found ${subcategories.length} subcategories for parent ${parentCategoryId}:`, subcategories);
            
            subcategorySelect.disabled = false;
            subcategorySelect.innerHTML = '<option value="">Select Subcategory</option>';
            
            if (subcategories.length === 0) {
                const option = document.createElement('option');
                option.value = '';
                option.textContent = 'No subcategories available';
                option.disabled = true;
                subcategorySelect.appendChild(option);
                console.warn('‚ö†Ô∏è No subcategories found for this parent category');
                return;
            }
            
            subcategories.forEach(cat => {
                const option = document.createElement('option');
                option.value = cat.id;
                option.textContent = cat.name_en || cat.name || 'Unknown Subcategory';
                subcategorySelect.appendChild(option);
            });
            
            console.log('‚úÖ Subcategories loaded successfully');
        }
        
        // Load subcategories for edit form when parent category is selected
        function loadEditSubcategories(parentCategoryId) {
            const subcategorySelect = document.getElementById('edit-subcategory');
            
            if (!parentCategoryId) {
                subcategorySelect.disabled = true;
                subcategorySelect.innerHTML = '<option value="">First select main category</option>';
                return;
            }
            
            if (!window.allCategoriesData) {
                console.error('Categories data not loaded');
                return;
            }
            
            // Filter subcategories for the selected parent
            const subcategories = window.allCategoriesData.filter(cat => 
                cat.parent_id && cat.parent_id.toString() === parentCategoryId.toString()
            );
            
            subcategorySelect.disabled = false;
            subcategorySelect.innerHTML = '<option value="">Select Subcategory</option>';
            
            subcategories.forEach(cat => {
                const option = document.createElement('option');
                option.value = cat.id;
                option.textContent = cat.name_en || cat.name || 'Unknown Subcategory';
                subcategorySelect.appendChild(option);
            });
            
            // Category type radio buttons for edit modal
            const categoryTypeRadios = document.querySelectorAll('input[name="category_type"]');
            categoryTypeRadios.forEach(radio => {
                radio.addEventListener('change', function() {
                    const parentSection = document.getElementById('parent-category-section');
                    if (this.value === 'sub') {
                        parentSection.classList.remove('hidden');
                        loadParentCategoriesForEdit();
                    } else {
                        parentSection.classList.add('hidden');
                    }
                });
            });
            
            // If no subcategories, show message
            if (subcategories.length === 0) {
                subcategorySelect.innerHTML = '<option value="">No subcategories available</option>';
                subcategorySelect.disabled = true;
            }
        }

        // Helper function to get parent category ID from subcategory ID
        function getParentCategoryId(subcategoryId) {
            if (window.allCategoriesData) {
                const subcategory = window.allCategoriesData.find(cat => cat.id.toString() === subcategoryId.toString());
                return subcategory ? subcategory.parent_id : null;
            }
            return null;
        }

        // Function to populate edit form with existing category data
        function populateEditCategorySelects(categoryId) {
            if (!window.allCategoriesData || !categoryId) return;
            
            const parentId = getParentCategoryId(categoryId);
            if (!parentId) return;
            
            // Set parent category
            const parentSelect = document.getElementById('edit-parent-category');
            if (parentSelect) {
                parentSelect.value = parentId;
                
                // Load subcategories for this parent
                loadEditSubcategories(parentId);
                
                // Set subcategory after a brief delay to ensure subcategories are loaded
                setTimeout(() => {
                    const subcategorySelect = document.getElementById('edit-subcategory');
                    if (subcategorySelect) {
                        subcategorySelect.value = categoryId;
                    }
                }, 100);
            }
        }
        
        // Override modal show functions to load categories
        const originalShowAddProductForm = window.showAddProductForm;
        window.showAddProductForm = async function() {
            console.log('üé¨ Opening add product form...');
            originalShowAddProductForm();
            
            try {
                await loadCategoriesForProductForm();
                console.log('‚úÖ Categories loaded successfully');
            } catch (error) {
                console.error('‚ùå Failed to load categories:', error);
                alert('Failed to load categories. Please refresh the page and try again.');
            }
        };
        
        const originalShowProductManagement = window.showProductManagement;
        window.showProductManagement = function() {
            originalShowProductManagement();
            loadCategoriesForProductForm();
        };
        
        // Initialize admin panel
        document.addEventListener('DOMContentLoaded', function() {
            console.log('üéØ Admin panel DOM loaded, initializing...');
            
            // Check if Supabase is available
            if (!window.supabase) {
                console.error('‚ùå Supabase not available');
                alert('Database connection failed. Please refresh the page.');
                return;
            }
            
            console.log('‚úÖ Supabase available, checking admin access...');
            checkAdminAccess();
        });
    </script>
</body>
</html>